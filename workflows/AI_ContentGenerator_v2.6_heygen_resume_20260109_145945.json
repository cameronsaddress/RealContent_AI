{"updatedAt":"2026-01-09T22:59:11.322Z","createdAt":"2026-01-08T05:43:31.306Z","id":"LNpBI12tR5p3NX3g","name":"AI ContentGenerator","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"content":"## 1. SCRAPE\nDiscover trending content from TikTok, Instagram, YouTube","width":280,"color":7},"id":"note-scrape","name":"Scrape Section","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1600,-96]},{"parameters":{"rule":{"interval":[{"triggerAtHour":6}]}},"id":"scrape-schedule","name":"Daily 6am Scrape","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1568,64]},{"parameters":{"httpMethod":"POST","path":"scrape-trends","responseMode":"responseNode","options":{}},"id":"scrape-webhook","name":"Scrape Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1568,240],"webhookId":"scrape-trends","onError":"continueRegularOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse incoming niche/platform parameters\nconst body = $input.first().json.body || $input.first().json;\n\n// Defaults\nconst niche = body.niche || 'real estate';\nconst hashtags = body.hashtags || ['realestate', 'realtor', 'homebuying', 'firsttimehomebuyer'];\nconst platforms = body.platforms || ['tiktok', 'instagram'];\nconst timeRange = body.time_range || '24h';\nconst resultsPerPlatform = body.results_per_platform || 50;\n\n// Build search terms from niche\nconst nicheTerms = niche.split(/[,;]+/).map(t => t.trim()).filter(t => t);\n\nreturn [{\n  json: {\n    niche,\n    nicheTerms,\n    hashtags,\n    platforms,\n    timeRange,\n    resultsPerPlatform,\n    scrapeStartedAt: new Date().toISOString()\n  }\n}];"},"id":"scrape-parse-params","name":"Parse Scrape Params","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1344,160]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"tiktok-check","leftValue":"={{ $json.platforms.includes('tiktok') }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-tiktok","name":"TikTok?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1120,-48]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"instagram-check","leftValue":"={{ $json.platforms.includes('instagram') }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-instagram","name":"Instagram?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1120,160]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"youtube-check","leftValue":"={{ $json.platforms.includes('youtube') }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-youtube","name":"YouTube?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1120,368]},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/clockworks~free-tiktok-scraper/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"hashtags\": {{ JSON.stringify($('Parse Scrape Params').first().json.hashtags) }},\n  \"resultsPerPage\": {{ $('Parse Scrape Params').first().json.resultsPerPlatform }}\n}","options":{"timeout":180000}},"id":"apify-tiktok","name":"Apify TikTok","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-864,-144],"credentials":{"httpHeaderAuth":{"id":"apify","name":"apify"}}},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/apify~instagram-hashtag-scraper/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"hashtags\": {{ JSON.stringify($('Parse Scrape Params').first().json.hashtags) }},\n  \"resultsType\": \"reels\",\n  \"resultsLimit\": {{ $('Parse Scrape Params').first().json.resultsPerPlatform }}\n}","options":{"timeout":180000}},"id":"apify-instagram","name":"Apify Instagram Reels","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-864,144],"credentials":{"httpHeaderAuth":{"id":"apify","name":"apify"}}},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/apify~youtube-scraper/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"searchKeywords\": {{ JSON.stringify($('Parse Scrape Params').first().json.nicheTerms) }},\n  \"sort\": \"relevance\",\n  \"maxResults\": {{ $('Parse Scrape Params').first().json.resultsPerPlatform }}\n}","options":{"timeout":180000}},"id":"apify-youtube","name":"Apify YouTube","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-864,432],"credentials":{"httpHeaderAuth":{"id":"apify","name":"apify"}}},{"parameters":{},"id":"skip-tiktok","name":"Skip TikTok","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-864,-288]},{"parameters":{},"id":"skip-instagram","name":"Skip Instagram","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-864,16]},{"parameters":{},"id":"skip-youtube","name":"Skip YouTube","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-864,304]},{"parameters":{},"id":"scrape-merge","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-608,160]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Normalize scraped items from different platforms\nconst items = $input.all();\nconst params = $('Parse Scrape Params').first().json;\nconst normalized = [];\n\nfor (const item of items) {\n  const data = item.json;\n  if (!data || typeof data !== 'object') continue;\n  \n  // Skip empty arrays or merge placeholders\n  if (Array.isArray(data) && data.length === 0) continue;\n  \n  // TikTok format\n  if (data.webVideoUrl || data.videoUrl) {\n    normalized.push({\n      platform: 'tiktok',\n      url: data.webVideoUrl || data.videoUrl,\n      title: data.text || data.desc || '',\n      views: data.playCount || 0,\n      likes: data.diggCount || 0,\n      comments: data.commentCount || 0,\n      shares: data.shareCount || 0,\n      engagement: (data.diggCount || 0) + (data.commentCount || 0) + (data.shareCount || 0),\n      author: data.authorMeta?.name || data.author || '',\n      created: data.createTime || null,\n      thumbnail: data.covers?.default || data.videoMeta?.coverUrl || ''\n    });\n  }\n  // Instagram Reels format\n  else if (data.url && (data.url.includes('instagram') || data.type === 'Reel')) {\n    normalized.push({\n      platform: 'instagram',\n      url: data.url || data.inputUrl,\n      title: data.caption || data.text || '',\n      views: data.playCount || data.videoPlayCount || 0,\n      likes: data.likesCount || data.likes || 0,\n      comments: data.commentsCount || data.comments || 0,\n      shares: 0,\n      engagement: (data.likesCount || data.likes || 0) + (data.commentsCount || data.comments || 0),\n      author: data.ownerUsername || data.author || '',\n      created: data.timestamp || null,\n      thumbnail: data.displayUrl || data.thumbnail || ''\n    });\n  }\n  // YouTube format\n  else if (data.url && data.url.includes('youtube')) {\n    normalized.push({\n      platform: 'youtube',\n      url: data.url,\n      title: data.title || '',\n      views: data.viewCount || 0,\n      likes: data.likes || 0,\n      comments: data.comments || 0,\n      shares: 0,\n      engagement: (data.likes || 0) + (data.comments || 0),\n      author: data.channelName || data.author || '',\n      created: data.uploadDate || null,\n      thumbnail: data.thumbnailUrl || ''\n    });\n  }\n}\n\n// Sort by engagement (highest first)\nnormalized.sort((a, b) => b.engagement - a.engagement);\n\n// Add metadata\nconst output = {\n  niche: params.niche,\n  platforms: params.platforms,\n  scrapedAt: params.scrapeStartedAt,\n  totalResults: normalized.length,\n  results: normalized\n};\n\nreturn [{ json: output }];"},"id":"scrape-normalize","name":"Normalize Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,160]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"HTTP-Referer","value":"http://100.83.153.43:5678"},{"name":"X-Title","value":"n8n-trend-analyzer"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  model: 'x-ai/grok-4.1-fast',\n  messages: [\n    {\n      role: 'system',\n      content: `You analyze trending social media content to find viral video ideas for a content creator.\\n\\nTarget niche: ${$json.niche}\\n\\nFor each piece of content, determine:\\n1. viral_score (1-10): How viral/engaging is this content?\\n2. pillar: One of: market_intelligence, educational_tips, lifestyle_local, brand_humanization\\n3. suggested_hook: A compelling hook to recreate this content\\n4. why_viral: Brief explanation of what makes it work\\n5. adaptable: true/false - Can this be adapted for the target niche?\\n\\nPILLAR DEFINITIONS:\\n- market_intelligence: Data, trends, market analysis, pricing, investment\\n- educational_tips: How-tos, tutorials, tips, process explanations\\n- lifestyle_local: Community, local events, lifestyle content\\n- brand_humanization: Personal stories, behind-the-scenes, relatable moments\\n\\nReturn JSON: { \"analyzed\": [{ \"url\", \"platform\", \"title\", \"views\", \"likes\", \"viral_score\", \"pillar\", \"suggested_hook\", \"why_viral\", \"adaptable\" }] }\\n\\nOnly include items with viral_score >= 6. Sort by viral_score descending.`\n    },\n    {\n      role: 'user',\n      content: `Analyze these ${$json.totalResults} trending items and identify the best content ideas:\\n\\n${JSON.stringify($json.results.slice(0, 30))}`\n    }\n  ],\n  temperature: 0.3,\n  max_tokens: 4000,\n  response_format: { type: 'json_object' }\n} }}","options":{"timeout":90000}},"id":"scrape-analyze-grok","name":"Analyze with Grok","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-160,160],"credentials":{"httpHeaderAuth":{"id":"openrouter","name":"openrouter"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse LLM response and format for API/UI\nconst response = $input.first().json;\nconst normalizedData = $('Normalize Data').first().json;\n\ntry {\n  const content = response.choices[0].message.content;\n  const parsed = JSON.parse(content);\n  const items = parsed.analyzed || parsed.items || [];\n  \n  // Filter for viral_score >= 6 and adaptable = true\n  const filtered = items.filter(item => \n    item.viral_score >= 6 && item.adaptable !== false\n  );\n  \n  return [{\n    json: {\n      success: true,\n      niche: normalizedData.niche,\n      scrapedAt: normalizedData.scrapedAt,\n      totalScraped: normalizedData.totalResults,\n      analyzedCount: filtered.length,\n      trends: filtered\n    }\n  }];\n} catch (error) {\n  return [{\n    json: {\n      success: false,\n      error: error.message,\n      niche: normalizedData.niche,\n      scrapedAt: normalizedData.scrapedAt,\n      totalScraped: normalizedData.totalResults,\n      analyzedCount: 0,\n      trends: []\n    }\n  }];\n}"},"id":"scrape-format-response","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,160]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Process trends, save to DB, and guarantee response\nconst data = $input.first().json;\nconst savedItems = [];\nlet savedCount = 0;\n\n// 1. Handle Empty/Error Case\nif (!data.success || !data.trends || data.trends.length === 0) {\n  return [{\n    json: {\n      success: true, // Return success so UI doesn't crash\n      niche: data.niche,\n      scrapedAt: data.scrapedAt,\n      totalScraped: data.totalScraped || 0,\n      analyzedCount: 0,\n      savedCount: 0,\n      message: 'No suitable trends found to save',\n      trends: []\n    }\n  }];\n}\n\n// 2. Process & Save Each Trend\nfor (const trend of data.trends) {\n  try {\n    // Infer platform\n    let platform = trend.platform;\n    const url = trend.url || '';\n    if (!platform || platform === 'unknown') {\n      if (url.includes('tiktok.com')) platform = 'tiktok';\n      else if (url.includes('instagram.com')) platform = 'instagram';\n      else if (url.includes('youtube.com') || url.includes('youtu.be')) platform = 'youtube';\n    }\n    \n    // Construct Payload\n    const payload = {\n      source_url: url,\n      source_platform: (platform ? platform.toLowerCase() : 'unknown'),\n      original_text: trend.title || '',\n      pillar: trend.pillar || 'educational_tips',\n      viral_score: trend.viral_score || 7,\n      suggested_hook: trend.suggested_hook || '',\n      why_viral: trend.why_viral || '',\n      status: 'pending'\n    };\n\n    // Send to Backend\n    // Using this.helpers.request (n8n built-in)\n    const response = await this.helpers.request({\n      method: 'POST',\n      url: 'http://backend:8000/api/content-ideas',\n      body: payload,\n      json: true\n    });\n    \n    if (response && response.id) {\n        savedItems.push(response);\n        savedCount++;\n    }\n  } catch (err) {\n    console.log(`Failed to save trend: ${err.message}`);\n    // Continue to next item, don't stop workflow\n  }\n}\n\n// 3. Return Summary Response\nreturn [{\n  json: {\n    success: true,\n    niche: data.niche,\n    scrapedAt: data.scrapedAt,\n    totalScraped: data.totalScraped,\n    analyzedCount: data.analyzedCount,\n    savedCount: savedCount,\n    message: `Saved ${savedCount} content ideas to database`,\n    trends: savedItems\n  }\n}];"},"id":"scrape-process-save","name":"Process & Save Trends","type":"n8n-nodes-base.code","typeVersion":2,"position":[288,160]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"scrape-respond","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[784,160]},{"parameters":{"content":"## 2. Auto Trigger\nSchedule (15min) + Webhook to start pipeline","height":140,"width":180,"color":4},"id":"note-auto-trigger","name":"Auto Trigger","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[144,-32]},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"id":"schedule-trigger","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[368,-32],"disabled":true},{"parameters":{"httpMethod":"POST","path":"trigger-pipeline","responseMode":"responseNode","options":{}},"id":"webhook-trigger","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[64,400],"webhookId":"eb59ea2b-8f7b-4ac5-a593-5febc10fa1da","onError":"continueRegularOutput"},{"parameters":{"url":"http://backend:8000/api/content-ideas?status=approved&limit=1","options":{}},"id":"get-approved-idea","name":"Get Approved Idea","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[416,480]},{"parameters":{"respondWith":"text","responseBody":"Pipeline Triggered","options":{}},"id":"trigger-respond-immediate","name":"Respond Immediately","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,544]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-specific-id","leftValue":"={{ $json.body?.content_idea_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"if-specific-id","name":"Specific ID?","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,400]},{"parameters":{"url":"=http://backend:8000/api/content-ideas/{{ $json.body.content_idea_id }}","options":{}},"id":"get-specific-idea","name":"Get Specific Idea","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[608,480]},{"parameters":{},"id":"merge-idea-sources","name":"Merge","type":"n8n-nodes-base.merge","typeVersion":3,"position":[496,224]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Normalize and validate content idea\nconst items = $input.all();\nlet idea = null;\n\nfor (const item of items) {\n  const data = item.json;\n  if (Array.isArray(data) && data.length > 0) {\n    idea = data[0];\n    break;\n  } else if (data && data.id) {\n    idea = data;\n    break;\n  }\n}\n\nif (!idea || !idea.id) {\n  return [{ json: { hasContent: false, message: 'No approved content found' } }];\n}\n\nreturn [{\n  json: {\n    hasContent: true,\n    content_idea_id: idea.id,\n    original_text: idea.original_text,\n    pillar: idea.pillar,\n    suggested_hook: idea.suggested_hook,\n    source_platform: idea.source_platform,\n    source_url: idea.source_url\n  }\n}];"},"id":"normalize-idea","name":"Normalize Idea","type":"n8n-nodes-base.code","typeVersion":2,"position":[640,224]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-content","leftValue":"={{ $json.hasContent }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-has-content","name":"Has Content?","type":"n8n-nodes-base.if","typeVersion":2,"position":[992,224]},{"parameters":{},"id":"no-content-end","name":"No Content","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1216,240]},{"parameters":{"content":"## Script Generation\nGrok 4.1 creates viral script","height":140,"width":180,"color":5},"id":"note-script-gen","name":"Script Gen","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,528]},{"parameters":{"method":"PATCH","url":"=http://backend:8000/api/content-ideas/{{ $json.content_idea_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"script_generating\"\n}","options":{}},"id":"update-status-processing","name":"Update Status","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[64,688]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"HTTP-Referer","value":"http://100.83.153.43:5678"},{"name":"X-Title","value":"n8n-video-pipeline"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  model: \"x-ai/grok-4.1-fast\",\n  messages: [\n    {\n      role: \"system\",\n      content: ($('Fetch Settings').first().json.llm && $('Fetch Settings').first().json.llm.character_persona ? $('Fetch Settings').first().json.llm.character_persona : 'You are Beth Anderson, an amazing realtor in Coeur d\\'Alene, Idaho and Liberty Lake, Washington. You are reviewing a viral video to provide value to your clients.') + \"\\n\\nUsing the provided content idea, write a script where you critique or praise the video, showing what is right or wrong, and demonstrating your expertise.\\nThe video will be playing behind you. You are the expert.\\n\\nStructure:\\n1. Hook: Catchy opening related to the topic.\\n2. Body: Your expert analysis.\\n3. Call to Action: How you can help them.\\n\\nGUIDELINES:\\n- Start with a hook that stops scrollers in the first 3 seconds\\n- Use conversational, energetic tone\\n- Include ONE clear call-to-action\\n- Add natural pauses marked with [PAUSE]\\n- Mark emphasis with *asterisks*\\n- Keep sentences short and punchy\\n- Total length: 150-250 words\\n\\nPILLAR TONES:\\n- market_intelligence: Data-driven, authoritative, slightly urgent\\n- educational_tips: Helpful, encouraging, clear steps\\n- lifestyle_local: Warm, community-focused, storytelling\\n- brand_humanization: Personal, relatable, authentic\\n\\nRETURN JSON:\\n{\\n  \\\"hook\\\": \\\"First 3 seconds text\\\",\\n  \\\"script\\\": \\\"Full script with [PAUSE] and *emphasis* markers\\\",\\n  \\\"cta\\\": \\\"Call to action text\\\",\\n  \\\"estimated_duration_seconds\\\": 45,\\n  \\\"suggested_broll\\\": [\\\"scene description 1\\\", \\\"scene description 2\\\", \\\"scene description 3\\\"]\\n}\"\n    },\n    {\n      role: \"user\",\n      content: \"Create a script based on this content idea:\\n\\nPillar: \" + $('Normalize Idea').first().json.pillar + \"\\nSuggested Hook: \" + $('Normalize Idea').first().json.suggested_hook + \"\\nOriginal Content: \" + ($('Normalize Idea').first().json.original_text ? $('Normalize Idea').first().json.original_text.substring(0, 1500) : '') + \"\\nSource: \" + $('Normalize Idea').first().json.source_platform\n    }\n  ],\n  temperature: 0.7,\n  max_tokens: 2000,\n  response_format: { type: \"json_object\" }\n} }}","options":{"timeout":60000}},"id":"generate-script-llm","name":"Generate Script (Grok)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[288,688],"credentials":{"httpHeaderAuth":{"id":"openrouter","name":"openrouter"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Parse script from LLM response\nconst items = $input.all();\nif (!items || items.length === 0) {\n  throw new Error('No input data received');\n}\n\nconst response = items[0].json;\nlet prevData = {};\n\ntry {\n  prevData = $('Normalize Idea').first().json;\n} catch (e) {\n  // Fallback if node reference fails\n}\n\ntry {\n  const content = response.choices[0].message.content;\n  \n  // Try to parse as JSON, handle markdown code blocks\n  let cleanContent = content;\n  if (content.includes('```json')) {\n    cleanContent = content.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (content.includes('```')) {\n    cleanContent = content.replace(/```\\n?/g, '').trim();\n  }\n  \n  const scriptData = JSON.parse(cleanContent);\n  \n  return [{\n    json: {\n      content_idea_id: prevData.content_idea_id || scriptData.content_idea_id,\n      hook: scriptData.hook || '',\n      body: scriptData.script || scriptData.body || '',\n      cta: scriptData.cta || '',\n      full_script: `${scriptData.hook || ''} ${scriptData.script || scriptData.body || ''} ${scriptData.cta || ''}`.trim(),\n      duration_estimate: scriptData.estimated_duration_seconds || scriptData.duration_estimate || 45,\n      suggested_broll: scriptData.suggested_broll || [],\n      pillar: prevData.pillar || scriptData.pillar || 'general',\n      source_url: prevData.source_url || ''\n    }\n  }];\n} catch (error) {\n  // Return error info for debugging\n  return [{\n    json: {\n      error: true,\n      errorMessage: error.message,\n      rawContent: response.choices?.[0]?.message?.content?.substring(0, 500) || 'No content',\n      content_idea_id: prevData.content_idea_id\n    }\n  }];\n}"},"id":"parse-script","name":"Parse Script","type":"n8n-nodes-base.code","typeVersion":2,"position":[512,688]},{"parameters":{"method":"POST","url":"http://backend:8000/api/scripts","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"content_idea_id\": {{ $json.content_idea_id }},\n  \"hook\": {{ JSON.stringify($json.hook) }},\n  \"body\": {{ JSON.stringify($json.script || '') }},\n  \"cta\": {{ JSON.stringify($json.cta) }},\n  \"full_script\": {{ JSON.stringify($json.hook + ' ' + $json.script + ' ' + $json.cta) }},\n  \"duration_estimate\": {{ $json.estimated_duration || 45 }},\n  \"status\": \"script_ready\"\n}","options":{}},"id":"save-script","name":"Save Script","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,688]},{"parameters":{"method":"POST","url":"http://backend:8000/api/assets","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"script_id\": {{ $json.id }},\n  \"status\": \"pending\"\n}","options":{}},"id":"create-asset-record","name":"Create Asset Record","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[944,688]},{"parameters":{"content":"## 4. GET VIDEO\nDownload source video from TikTok/Instagram/YouTube using yt-dlp","height":140,"width":180,"color":6},"id":"note-get-video","name":"Get Video","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,912]},{"parameters":{"content":"## Create Voice\nElevenLabs TTS + duration check","height":140,"width":180,"color":7},"id":"note-create-voice","name":"Create Voice","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,1168]},{"parameters":{"url":"http://backend:8000/api/config/character","options":{}},"id":"get-character-config","name":"Get Character Config","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[64,1184]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Get character configuration from the previous node (HTTP Request)\nconst items = $input.all();\nconst charConfig = items[0]?.json || {};\n\n// Get script and asset data from upstream - use try/catch for safety\nlet scriptData = {}, assetData = {}, parseData = {}, sourceVideoPath = '';\n\ntry {\n  scriptData = $('Save Script').first().json;\n} catch (e) { console.log('Save Script not found'); }\n\ntry {\n  assetData = $('Create Asset Record').first().json;\n} catch (e) { console.log('Create Asset Record not found'); }\n\ntry {\n  parseData = $('Parse Script').first().json;\n} catch (e) { console.log('Parse Script not found'); }\n\ntry {\n  sourceVideoPath = $('Verify Download').first().json.saved_path || '';\n} catch (e) { console.log('Verify Download not found'); }\n\n// Clean script for TTS (remove pauses, scene directions, extra spaces)\nlet text = parseData.body || parseData.script || '';\ntext = text.replace(/\\[PAUSE\\]/gi, '...');\ntext = text.replace(/\\*(.*?)\\*/g, '$1');\ntext = text.replace(/\\s+/g, ' ').trim();\n\nif (parseData.cta) {\n  text = text + ' ... ' + parseData.cta;\n}\n\n// Robust Voice ID Selection\nlet voiceId = charConfig.voice_id;\nif (!voiceId || typeof voiceId !== 'string' || voiceId.trim().length < 5) {\n  console.log(`Invalid or missing voice_id '${voiceId}', falling back to Rachel.`);\n  voiceId = '21m00Tcm4TlvDq8ikWAM'; // Rachel\n} else {\n  voiceId = voiceId.trim();\n}\n\n// Avatar type mapping:\n// - video_avatar: HeyGen premade video avatar\n// - talking_photo: HeyGen existing talking photo\n// - custom_photo: User-uploaded photo\nconst avatarType = charConfig.avatar_type || 'video_avatar';\n\nreturn [{\n  json: {\n    asset_id: assetData.id || null,\n    script_id: scriptData.id || parseData.script_id || null,\n    content_idea_id: parseData.content_idea_id || null,\n    text_for_tts: text,\n    voice_id: voiceId,\n    avatar_id: charConfig.avatar_id || 'Kristin_pubblic_3_20240108',\n    avatar_type: avatarType,\n    config_image_url: charConfig.image_url || '',\n    broll_paths: sourceVideoPath ? [sourceVideoPath] : []\n  }\n}];"},"id":"prepare-tts-text","name":"Prepare TTS Text","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,1184]},{"parameters":{"method":"POST","url":"=https://api.elevenlabs.io/v1/text-to-speech/{{ $json.voice_id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"audio/mpeg"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { \"text\": $json.text_for_tts, \"model_id\": \"eleven_multilingual_v2\", \"voice_settings\": { \"stability\": 0.5, \"similarity_boost\": 0.75, \"style\": 0.5, \"use_speaker_boost\": true } } }}","options":{"response":{},"timeout":120000}},"id":"generate-voice","name":"Generate Voice (ElevenLabs)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[656,1248],"credentials":{"httpHeaderAuth":{"id":"elevenlabs","name":"elevenlabs"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\nconst items = $input.all();\nconst sourceData = items[0]?.json || {};\n\ntry {\n  const scriptId = sourceData.script_id;\n  const filePath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n  const exists = fs.existsSync(filePath);\n  \n  // MERGE source data so voice_id/text_for_tts persist to the Generator\n  return [{ \n    json: { \n      ...sourceData,\n      exists, \n      filePath, \n      script_id: scriptId,\n      voice_id: sourceData.voice_id \n    } \n  }];\n} catch (e) {\n  return [{ json: { ...sourceData, exists: false, error: e.message } }];\n}"},"id":"check-voice-exists","name":"Check Voice Exists","type":"n8n-nodes-base.code","typeVersion":2,"position":[368,1184]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"file-exists","leftValue":"={{ $json.exists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-voice-exists","name":"Voice Exists?","type":"n8n-nodes-base.if","typeVersion":2,"position":[512,1184]},{"parameters":{"fileName":"=/home/node/.n8n-files/assets/audio/{{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3","options":{}},"id":"save-voice-file","name":"Save Voice","type":"n8n-nodes-base.writeBinaryFile","typeVersion":1,"position":[800,1248]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const { execSync } = require('child_process');\nconst items = $input.all();\nconst inputData = items[0]?.json || {};\n\n// Get script_id from input or from Prepare TTS Text\nlet scriptId = inputData.script_id;\nif (!scriptId) {\n  try {\n    scriptId = $('Prepare TTS Text').first().json.script_id;\n  } catch (e) {\n    scriptId = 22; // fallback\n  }\n}\n\nconst audioPath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n\ntry {\n  const result = execSync(`ffprobe -v quiet -show_entries format=duration -of csv=p=0 \"${audioPath}\"`, { encoding: 'utf-8' });\n  const duration = parseFloat(result.trim()) || 45;\n  return [{ json: { ...inputData, duration, voiceover_duration: duration, success: true } }];\n} catch (error) {\n  return [{ json: { ...inputData, duration: 45, voiceover_duration: 45, success: false, error: error.message } }];\n}"},"id":"get-voice-duration","name":"Get Duration","type":"n8n-nodes-base.code","typeVersion":2,"position":[944,1168]},{"parameters":{"method":"PATCH","url":"=http://backend:8000/api/assets/{{ $('Prepare TTS Text').first().json.asset_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"voiceover_path\": \"/home/node/.n8n-files/assets/audio/{{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3\",\n  \"status\": \"voice_ready\"\n}","options":{}},"id":"update-asset-voice","name":"Update Asset Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1088,1168]},{"parameters":{"filePath":"=/home/node/.n8n-files/assets/audio/{{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3"},"id":"read-audio-file","name":"Read Audio File","type":"n8n-nodes-base.readBinaryFile","typeVersion":1,"position":[1296,1168]},{"parameters":{"content":"## Create Avatar\nHeyGen lip-sync video generation","height":140,"width":180,"color":3},"id":"note-create-avatar","name":"Create Avatar","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,1728]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Parse inputs from upstream nodes\nconst uploadResult = $('Upload HeyGen Audio').first().json;\nconst durationResult = $('Get Duration').first().json;\nconst ttsData = $('Prepare TTS Text').first().json;\n\n// Get greenscreen settings from Fetch Settings\nconst fetchedSettings = $('Fetch Settings').first().json;\nconst videoSettings = fetchedSettings?.settings?.video || {};\nconst greenscreenEnabled = videoSettings.greenscreen_enabled ?? true;\nconst greenscreenColor = videoSettings.greenscreen_color || '#00FF00';\n\n// Check for Dynamic Photo Upload (only used for custom_photo type)\nlet dynamicPhotoId = null;\ntry {\n  const photoUpload = $('Upload Talking Photo').first();\n  if (photoUpload && photoUpload.json && photoUpload.json.data) {\n    dynamicPhotoId = photoUpload.json.data.talking_photo_id || photoUpload.json.data.id;\n  }\n} catch(e) {\n  // No upload - that's fine for non-custom_photo types\n}\n\nlet duration = 45;\ntry {\n  duration = parseFloat(durationResult.stdout?.trim()) || 45;\n} catch (e) {}\n\n// Avatar Logic based on avatar_type from Character config\nlet avatarId = ttsData.avatar_id;\nlet avatarType = ttsData.avatar_type || 'video_avatar';\n\n// Handle avatar types:\n// - video_avatar: Use HeyGen's premade video avatar (avatar_type = 'avatar')\n// - talking_photo: Use HeyGen's existing talking photo (avatar_type = 'talking_photo')\n// - custom_photo: Use dynamically uploaded photo (avatar_type = 'talking_photo')\n\nlet heygenAvatarType = 'avatar'; // Default for HeyGen API\n\nif (avatarType === 'custom_photo') {\n  // Custom uploaded photo - use the dynamic upload ID\n  if (dynamicPhotoId) {\n    avatarId = dynamicPhotoId;\n    heygenAvatarType = 'talking_photo';\n  } else {\n    // Fallback to default video avatar if upload failed\n    console.log('Missing dynamic photo upload, falling back to default avatar');\n    avatarId = 'Anna_public_3_20240108';\n    heygenAvatarType = 'avatar';\n  }\n} else if (avatarType === 'talking_photo') {\n  // Use existing talking photo from HeyGen's library\n  heygenAvatarType = 'talking_photo';\n} else {\n  // video_avatar - use premade HeyGen avatar\n  heygenAvatarType = 'avatar';\n}\n\nreturn [{\n  json: {\n    asset_id: ttsData.asset_id,\n    script_id: ttsData.script_id,\n    content_idea_id: ttsData.content_idea_id,\n    voice_path: `/home/node/.n8n-files/assets/audio/${ttsData.script_id}_voice.mp3`,\n    duration_seconds: Math.round(duration * 10) / 10,\n    broll_paths: ttsData.broll_paths,\n    avatar_id: avatarId,\n    avatar_type: heygenAvatarType,\n    audio_asset_id: uploadResult.data?.id || '',\n    greenscreen_enabled: greenscreenEnabled,\n    greenscreen_color: greenscreenColor\n  }\n}];"},"id":"prepare-heygen-data","name":"Prepare HeyGen Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,1760]},{"parameters":{"method":"POST","url":"https://api.heygen.com/v2/video/generate","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{\n{\n  \"video_inputs\": [\n    {\n      \"character\": $json.avatar_type === 'talking_photo'\n        ? {\n            \"type\": \"talking_photo\",\n            \"talking_photo_id\": $json.avatar_id\n          }\n        : {\n            \"type\": \"avatar\",\n            \"avatar_id\": $json.avatar_id,\n            \"avatar_style\": \"normal\"\n          },\n      \"voice\": {\n        \"type\": \"audio\",\n        \"audio_asset_id\": $json.audio_asset_id\n      },\n      \"background\": $json.greenscreen_enabled\n        ? {\n            \"type\": \"color\",\n            \"value\": $json.greenscreen_color || \"#00FF00\"\n          }\n        : {\n            \"type\": \"color\",\n            \"value\": \"#000000\"\n          }\n    }\n  ],\n  \"dimension\": {\n    \"width\": 720,\n    \"height\": 1280\n  },\n  \"aspect_ratio\": \"9:16\"\n}\n}}","options":{"timeout":60000}},"id":"create-heygen-video","name":"Create HeyGen Video","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[576,1776],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\ntry {\n  const sourceNode = $('Prepare HeyGen Data').first();\n  const sourceData = sourceNode.json;\n  const scriptId = sourceData.script_id;\n  const filePath = `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\n  const exists = fs.existsSync(filePath);\n  \n  // MERGE source data so audio_asset_id / avatar_id persist to the Generator\n  return [{ \n      json: { \n          ...sourceData,\n          exists, \n          filePath, \n          script_id: scriptId\n      } \n  }];\n} catch (e) {\n  return [{ json: { exists: false, error: e.message } }];\n}"},"id":"check-video-exists","name":"Check Video Exists","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,1760]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"file-exists","leftValue":"={{ $json.exists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-video-exists","name":"Video Exists?","type":"n8n-nodes-base.if","typeVersion":2,"position":[384,1760]},{"parameters":{"jsCode":"// Extract HeyGen video ID, save to database, and initialize retry counter\nconst response = $input.first().json;\nconst prevData = $('Prepare HeyGen Data').first().json;\n\nif (!response.data?.video_id) {\n  throw new Error(`HeyGen error: ${JSON.stringify(response)}`);\n}\n\nconst heygenVideoId = response.data.video_id;\nconst assetId = prevData.asset_id;\n\n// Save heygen_video_id to database immediately\ntry {\n  const saveResponse = await fetch(`http://backend:8000/api/assets/${assetId}`, {\n    method: 'PATCH',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ \n      heygen_video_id: heygenVideoId,\n      status: 'avatar_generating'\n    })\n  });\n  \n  if (!saveResponse.ok) {\n    console.log(`Warning: Failed to save heygen_video_id: ${saveResponse.status}`);\n  } else {\n    console.log(`Saved heygen_video_id ${heygenVideoId} to asset ${assetId}`);\n  }\n} catch (e) {\n  console.log(`Warning: Error saving heygen_video_id: ${e.message}`);\n}\n\nreturn [{\n  json: {\n    ...prevData,\n    heygen_video_id: heygenVideoId,\n    retry_count: 0,\n    max_retries: 20\n  }\n}];"},"id":"extract-heygen-id","name":"Extract Video ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[384,1632]},{"parameters":{"amount":30},"id":"wait-heygen","name":"Wait 30s","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[576,1632],"webhookId":"heygen-wait"},{"parameters":{"url":"=https://api.heygen.com/v1/video_status.get?video_id={{ $json.heygen_video_id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{}},"id":"check-heygen-status","name":"Check Status","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[800,1776],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Increment retry counter and check max\nconst inputData = $input.first().json;\nconst retryCount = (inputData.retry_count || 0) + 1;\nconst maxRetries = inputData.max_retries || 20;\n\nif (retryCount > maxRetries) {\n  throw new Error(`HeyGen timeout: Video ${inputData.heygen_video_id} did not complete after ${maxRetries} retries (~${maxRetries} minutes). Last status: ${inputData.heygen_status}`);\n}\n\nreturn [{\n  json: {\n    ...inputData,\n    retry_count: retryCount\n  }\n}];"},"id":"increment-retry","name":"Increment Retry","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,1968]},{"parameters":{"amount":60},"id":"wait-retry","name":"Wait & Retry","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1248,1968],"webhookId":"heygen-retry"},{"parameters":{"url":"={{ $('Check Status').first().json.data.video_url }}","options":{"response":{"response":{"responseFormat":"file"}},"timeout":180000}},"id":"download-avatar","name":"Download Avatar","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1088,1776]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const fs = require('fs');\nconst item = $input.item;\ntry {\n  const scriptId = $('Extract Video ID').first().json.script_id;\n  const fileName = `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\n  \n  if (item.binary && item.binary.data) {\n    fs.writeFileSync(fileName, Buffer.from(item.binary.data.data, 'base64'));\n    item.json.saved_path = fileName;\n  }\n} catch (e) {\n  console.log('Error writing avatar file: ' + e.message);\n  throw e;\n}\nreturn item;"},"id":"save-avatar-file","name":"Save Avatar","type":"n8n-nodes-base.code","typeVersion":2,"position":[1232,1776]},{"parameters":{"content":"## Combine Videos + Music\nFFmpeg chromakey compositing","height":140,"width":180,"color":2},"id":"note-combine","name":"Combine Vids","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,2112]},{"parameters":{"jsCode":"const fs = require('fs');\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input data', success: false } }];\n}\n\nconst sourceData = items[0].json;\nconst scriptId = sourceData.script_id;\n\n// Get settings from input\nconst settings = sourceData.settings || {\n  audio: { original_volume: 0.7, avatar_volume: 1.0, music_volume: 0.3, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5, music_autoduck: true },\n  video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow' }\n};\n\nconst audioSettings = settings.audio || {};\nconst videoSettings = settings.video || {};\n\n// Audio settings\nconst origVol = audioSettings.original_volume ?? 0.7;\nconst avatarVol = audioSettings.avatar_volume ?? 1.0;\nconst musicVol = audioSettings.music_volume ?? 0.3;\nconst duckEnabled = audioSettings.ducking_enabled ?? true;\nconst avatarDelay = audioSettings.avatar_delay_seconds ?? 3;\nconst duckTo = audioSettings.duck_to_percent ?? 0.5;\nconst musicAutoduck = audioSettings.music_autoduck ?? true;\n\n// Video settings\nconst outputWidth = videoSettings.output_width || 1080;\nconst outputHeight = videoSettings.output_height || 1920;\nconst crf = videoSettings.crf || 18;\nconst preset = videoSettings.preset || 'slow';\n\n// File paths\nconst avatarPath = sourceData.avatar_path || `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\nconst sourcePath = sourceData.source_video_path || `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\nconst voicePath = sourceData.voice_path || `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\nconst outputPath = `/home/node/.n8n-files/assets/output/${scriptId}_combined.mp4`;\n\n// Check for active music file\nconst musicDir = '/home/node/.n8n-files/assets/music';\nlet musicPath = null;\ntry {\n  if (fs.existsSync(musicDir)) {\n    const files = fs.readdirSync(musicDir).filter(f => f.endsWith('.mp3') || f.endsWith('.wav'));\n    const activeFile = files.find(f => f.startsWith('active_'));\n    if (activeFile) {\n      musicPath = `${musicDir}/${activeFile}`;\n    } else if (files.length > 0) {\n      musicPath = `${musicDir}/${files[0]}`;\n    }\n  }\n} catch (e) {\n  console.log('No music directory or files found');\n}\n\nconst avatarExists = fs.existsSync(avatarPath);\nconst sourceExists = fs.existsSync(sourcePath);\nconst voiceExists = fs.existsSync(voicePath);\nconst musicExists = musicPath && fs.existsSync(musicPath);\n\nif (!avatarExists) {\n  return [{ json: { error: `Avatar not found: ${avatarPath}`, success: false } }];\n}\n\n// Build inputs\nlet inputs = '';\nlet sourceIndex = -1, avatarIndex = -1, voiceIndex = -1, musicIndex = -1;\nlet inputCount = 0;\n\nif (sourceExists) {\n  inputs += `-stream_loop -1 -i \"${sourcePath}\"`;\n  sourceIndex = inputCount++;\n}\n\ninputs += ` -i \"${avatarPath}\"`;\navatarIndex = inputCount++;\n\nif (voiceExists) {\n  inputs += ` -i \"${voicePath}\"`;\n  voiceIndex = inputCount++;\n}\n\nif (musicExists && musicVol > 0) {\n  inputs += ` -stream_loop -1 -i \"${musicPath}\"`;\n  musicIndex = inputCount++;\n}\n\n// Build filter complex\nlet fc = '';\n\n// VIDEO: Scale and overlay avatar at BOTTOM-LEFT\nif (sourceExists) {\n  fc += `[${sourceIndex}:v]scale=${outputWidth}:${outputHeight}:force_original_aspect_ratio=increase,crop=${outputWidth}:${outputHeight},setsar=1[bg];`;\n  fc += `[${avatarIndex}:v]scale=${outputWidth}:-1,chromakey=0x00FF00:0.1:0.2[avatar_keyed];`;\n  fc += `[bg][avatar_keyed]overlay=0:H-h:shortest=1[outv];`;\n} else {\n  fc += `[${avatarIndex}:v]scale=${outputWidth}:-1,chromakey=0x00FF00:0.1:0.2[avatar_keyed];`;\n  fc += `color=c=#1a1a2e:s=${outputWidth}x${outputHeight}:d=120[bg];`;\n  fc += `[bg][avatar_keyed]overlay=0:H-h:shortest=1[outv];`;\n}\n\n// AUDIO: Mix original, voice, and music\nconst delayMs = Math.round(avatarDelay * 1000);\n\nif (musicExists && musicVol > 0 && voiceExists) {\n  // Voice track (delayed) - split into two: one for sidechain key, one for mix\n  fc += `[${voiceIndex}:a]adelay=${delayMs}|${delayMs},volume=${avatarVol},asplit=2[voice][voice_key];`;\n  \n  // Music track - with or without sidechaincompress based on music_autoduck setting\n  if (musicAutoduck) {\n    // Use sidechaincompress to auto-duck music when voice plays\n    fc += `[${musicIndex}:a]volume=${musicVol}[music_vol];`;\n    fc += `[music_vol][voice_key]sidechaincompress=threshold=0.02:ratio=4:attack=50:release=500[music_processed];`;\n  } else {\n    // No auto-ducking, just constant volume\n    fc += `[${musicIndex}:a]volume=${musicVol}[music_processed];`;\n    fc += `[voice_key]anullsink;`;  // discard the unused split\n  }\n  \n  if (sourceExists && duckEnabled) {\n    fc += `[${sourceIndex}:a]volume=${origVol}:enable='lt(t,${avatarDelay})',volume=${origVol * duckTo}:enable='gte(t,${avatarDelay})'[orig];`;\n    fc += `[orig][voice][music_processed]amix=inputs=3:duration=shortest:dropout_transition=0,volume=2.5[outa]`;\n  } else if (sourceExists) {\n    fc += `[${sourceIndex}:a]volume=${origVol}[orig];`;\n    fc += `[orig][voice][music_processed]amix=inputs=3:duration=shortest:dropout_transition=0,volume=2.5[outa]`;\n  } else {\n    fc += `[voice][music_processed]amix=inputs=2:duration=shortest:dropout_transition=0,volume=2[outa]`;\n  }\n} else if (voiceExists) {\n  // No music, just original + voice\n  fc += `[${voiceIndex}:a]adelay=${delayMs}|${delayMs},volume=${avatarVol}[voice];`;\n  if (sourceExists && duckEnabled) {\n    fc += `[${sourceIndex}:a]volume=${origVol}:enable='lt(t,${avatarDelay})',volume=${origVol * duckTo}:enable='gte(t,${avatarDelay})'[orig];`;\n    fc += `[orig][voice]amix=inputs=2:duration=longest:dropout_transition=0,volume=2[outa]`;\n  } else if (sourceExists) {\n    fc += `[${sourceIndex}:a]volume=${origVol}[orig];`;\n    fc += `[orig][voice]amix=inputs=2:duration=longest:dropout_transition=0,volume=2[outa]`;\n  } else {\n    fc += `[voice]acopy[outa]`;\n  }\n} else {\n  fc += `[${avatarIndex}:a]aformat=channel_layouts=stereo[outa]`;\n}\n\nconst ffmpegCmd = `ffmpeg -y ${inputs} -filter_complex \"${fc}\" ` +\n  `-map \"[outv]\" -map \"[outa]\" ` +\n  `-c:v libx264 -preset ${preset} -crf ${crf} ` +\n  `-s ${outputWidth}x${outputHeight} ` +\n  `-c:a aac -b:a 192k -ar 48000 ` +\n  `-movflags +faststart -pix_fmt yuv420p ` +\n  `\"${outputPath}\"`;\n\nreturn [{\n  json: {\n    asset_id: sourceData.asset_id,\n    script_id: scriptId,\n    content_idea_id: sourceData.content_idea_id,\n    ffmpeg_command: ffmpegCmd,\n    output_path: outputPath,\n    avatar_path: avatarPath,\n    source_video_path: sourcePath,\n    voice_path: voicePath,\n    music_path: musicPath,\n    music_enabled: musicExists && musicVol > 0,\n    music_autoduck: musicAutoduck,\n    settings: settings\n  }\n}];"},"id":"build-ffmpeg-cmd","name":"Build FFmpeg Command","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,2128]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const { execSync } = require('child_process');\nconst fs = require('fs');\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\nconst ffmpegCmd = inputData.ffmpeg_command;\nconst outputPath = inputData.output_path;\nconst avatarPath = inputData.avatar_path;\n\n// Check if input files exist first\nconst avatarExists = fs.existsSync(avatarPath);\nif (!avatarExists) {\n  return [{ json: { \n    ...inputData,\n    stderr: `Avatar file not found: ${avatarPath}`,\n    exitCode: 1,\n    success: false,\n    avatar_exists: false\n  }}];\n}\n\n// Ensure output directory exists\nconst outputDir = outputPath.substring(0, outputPath.lastIndexOf('/'));\nif (!fs.existsSync(outputDir)) {\n  fs.mkdirSync(outputDir, { recursive: true });\n}\n\ntry {\n  // Execute FFmpeg with stderr capture\n  const result = execSync(ffmpegCmd, { \n    encoding: 'utf-8', \n    timeout: 300000,\n    maxBuffer: 50 * 1024 * 1024\n  });\n  \n  const fileExists = fs.existsSync(outputPath);\n  const stats = fileExists ? fs.statSync(outputPath) : null;\n  \n  return [{ json: { \n    ...inputData,\n    stdout: result || '', \n    exitCode: 0, \n    success: fileExists && stats && stats.size > 1000,\n    file_size: stats ? stats.size : 0\n  }}];\n} catch (error) {\n  const fileExists = fs.existsSync(outputPath);\n  const stats = fileExists ? fs.statSync(outputPath) : null;\n  \n  if (fileExists && stats && stats.size > 1000) {\n    return [{ json: { \n      ...inputData,\n      stderr: error.stderr || error.message || '', \n      exitCode: 0, \n      success: true,\n      file_size: stats.size\n    }}];\n  }\n  \n  return [{ json: { \n    ...inputData,\n    stdout: error.stdout || '', \n    stderr: `FFmpeg compose failed: ${error.stderr || error.message || 'Unknown error'}`, \n    exitCode: error.status || 1, \n    success: false \n  }}];\n}"},"id":"run-ffmpeg-combine","name":"Run FFmpeg","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,2128]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"ffmpeg-success","leftValue":"={{ $json.exitCode }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-ffmpeg-success","name":"Success?","type":"n8n-nodes-base.if","typeVersion":2,"position":[368,2128]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input to handle', handled: true } }];\n}\n\nconst inputData = items[0].json;\n\n// Log error and return structured error data\nreturn [{\n  json: {\n    ...inputData,\n    error_handled: true,\n    error_message: inputData.stderr || inputData.error || 'Unknown error'\n  }\n}];"},"id":"handle-ffmpeg-error","name":"Handle Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[544,2144]},{"parameters":{"content":"## Caption\nGenerate SRT + burn captions with FFmpeg","height":140,"width":180},"id":"note-caption","name":"Caption","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,2448]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Prepare data for Whisper transcription\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\nconst inputData = items[0].json;\n\nreturn [{\n  json: {\n    asset_id: inputData.asset_id,\n    script_id: inputData.script_id,\n    content_idea_id: inputData.content_idea_id,\n    combined_video_path: inputData.output_path,\n    audio_path: `/home/node/.n8n-files/assets/audio/${inputData.script_id}_voice.mp3`\n  }\n}];"},"id":"prepare-whisper","name":"Prepare Whisper","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Read audio file and return as binary for Whisper\nconst fs = require('fs');\nconst path = require('path');\n\nconst inputData = $input.first().json;\nconst audioPath = inputData.audio_path;\nconst scriptId = inputData.script_id;\nconst fileName = `${scriptId}_voice.mp3`;\n\n// Read the file as binary\nconst fileBuffer = fs.readFileSync(audioPath);\nconst base64Data = fileBuffer.toString('base64');\n\nreturn [{\n  json: {\n    ...inputData,\n    filePath: audioPath,\n    fileName: fileName\n  },\n  binary: {\n    data: {\n      data: base64Data,\n      mimeType: 'audio/mpeg',\n      fileName: fileName,\n      fileExtension: 'mp3'\n    }\n  }\n}];"},"id":"read-audio-for-whisper","name":"Read Audio for Whisper","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,2480]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/audio/transcriptions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"model","value":"whisper-1"},{"name":"response_format","value":"srt"},{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{"timeout":120000}},"id":"whisper-transcribe","name":"Whisper Transcribe","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[384,2480],"credentials":{"httpHeaderAuth":{"id":"openai","name":"openai"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Extract SRT content from Whisper response\nconst response = $input.first().json;\nconst prevData = $('Prepare Whisper').first().json;\n\n// Whisper returns SRT as plain text in the 'data' field\nconst srtContent = typeof response === 'string' ? response : (response.data || response.text || JSON.stringify(response));\n\nreturn [{\n  json: {\n    asset_id: prevData.asset_id,\n    script_id: prevData.script_id,\n    content_idea_id: prevData.content_idea_id,\n    combined_video_path: prevData.combined_video_path,\n    srt_content: srtContent\n  }\n}];"},"id":"parse-whisper-response","name":"Parse Whisper Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[544,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Save SRT file\nconst fs = require('fs');\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\nconst scriptId = inputData.script_id;\nconst srtPath = `/home/node/.n8n-files/assets/captions/${scriptId}_captions.srt`;\nconst content = inputData.srt_content || '';\n\n// Ensure directory exists\nconst dir = '/home/node/.n8n-files/assets/captions';\nif (!fs.existsSync(dir)) {\n  fs.mkdirSync(dir, { recursive: true });\n}\n\n// Write the SRT file\nfs.writeFileSync(srtPath, content, 'utf8');\n\nreturn [{\n  json: {\n    ...inputData,\n    srt_path: srtPath\n  }\n}];"},"id":"save-srt","name":"Save SRT","type":"n8n-nodes-base.code","typeVersion":2,"position":[704,2480]},{"parameters":{"jsCode":"// Build FFmpeg caption burn command - TikTok style captions at TOP\n// Now enforces 1080p output and uses proper font sizing\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\nconst scriptId = inputData.script_id;\n\n// Get video settings (passed through from earlier nodes)\nconst settings = inputData.settings || {};\nconst videoSettings = settings.video || {};\nconst outputWidth = videoSettings.output_width || 1080;\nconst outputHeight = videoSettings.output_height || 1920;\nconst crf = videoSettings.crf || 18;\nconst preset = videoSettings.preset || 'slow';\n\n// Use actual paths from input\nconst combinedPath = inputData.combined_video_path || `/home/node/.n8n-files/assets/output/${scriptId}_combined.mp4`;\nconst srtPath = inputData.srt_path;\nconst finalPath = `/home/node/.n8n-files/assets/output/${scriptId}_final.mp4`;\n\n// TikTok-style captions properly sized for 1080x1920:\n// - FontSize=12 is appropriate for 1080p vertical video (was 18 which is too big)\n// - Alignment=8 = top-center\n// - MarginV=80 = padding from top\n// - Bold white text with black outline for readability\nconst subtitleFilter = `subtitles=${srtPath}:force_style='FontName=Arial,FontSize=12,PrimaryColour=&HFFFFFF,OutlineColour=&H000000,BackColour=&H40000000,Outline=2,Shadow=1,Bold=1,Alignment=8,MarginV=80,MarginL=60,MarginR=60'`;\n\n// Enforce output resolution with high quality settings\nconst ffmpegCmd = `ffmpeg -y -i \"${combinedPath}\" ` +\n  `-vf \"${subtitleFilter}\" ` +\n  `-c:v libx264 -preset ${preset} -crf ${crf} ` +\n  `-s ${outputWidth}x${outputHeight} ` +\n  `-c:a copy ` +\n  `-movflags +faststart ` +\n  `-pix_fmt yuv420p ` +\n  `\"${finalPath}\"`;\n\nreturn [{\n  json: {\n    ...inputData,\n    ffmpeg_caption_command: ffmpegCmd,\n    final_path: finalPath,\n    combined_path: combinedPath\n  }\n}];"},"id":"build-caption-cmd","name":"Build Caption Cmd","type":"n8n-nodes-base.code","typeVersion":2,"position":[864,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Burn captions via video-processor /caption endpoint\nconst http = require('http');\n\nconst inputData = $input.first().json;\nconst scriptId = inputData.script_id;\n\n// Translate n8n paths to video-processor paths\nfunction translatePath(n8nPath) {\n  const pathMappings = [\n    { from: '/home/node/.n8n-files/assets/avatar/', to: '/avatar/' },\n    { from: '/home/node/.n8n-files/assets/audio/', to: '/audio/' },\n    { from: '/home/node/.n8n-files/assets/videos/', to: '/downloads/' },\n    { from: '/home/node/.n8n-files/assets/music/', to: '/music/' },\n    { from: '/home/node/.n8n-files/assets/captions/', to: '/captions/' },\n    { from: '/home/node/.n8n-files/assets/output/', to: '/outputs/' },\n    { from: '/home/node/.n8n-files/assets/combined/', to: '/outputs/' }\n  ];\n  for (const mapping of pathMappings) {\n    if (n8nPath && n8nPath.startsWith(mapping.from)) {\n      return n8nPath.replace(mapping.from, mapping.to);\n    }\n  }\n  return n8nPath;\n}\n\nconst captionData = {\n  script_id: String(scriptId),\n  video_path: translatePath(inputData.combined_path || `/home/node/.n8n-files/assets/output/${scriptId}_combined.mp4`),\n  srt_path: translatePath(inputData.srt_path || `/home/node/.n8n-files/assets/captions/${scriptId}_captions.srt`),\n  output_filename: `${scriptId}_final.mp4`,\n  use_gpu: true\n};\n\nfunction httpPost(body) {\n  return new Promise((resolve, reject) => {\n    const postData = JSON.stringify(body);\n    const options = {\n      hostname: 'video-processor',\n      port: 8080,\n      path: '/caption',\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Content-Length': Buffer.byteLength(postData)\n      }\n    };\n    const req = http.request(options, (res) => {\n      let data = '';\n      res.on('data', chunk => data += chunk);\n      res.on('end', () => {\n        try {\n          resolve({ statusCode: res.statusCode, body: JSON.parse(data) });\n        } catch (e) {\n          resolve({ statusCode: res.statusCode, body: data });\n        }\n      });\n    });\n    req.on('error', reject);\n    req.write(postData);\n    req.end();\n  });\n}\n\ntry {\n  const result = await httpPost(captionData);\n  if (result.statusCode === 200) {\n    return [{ json: { \n      ...inputData, \n      final_path: `/home/node/.n8n-files/assets/output/${scriptId}_final.mp4`,\n      success: true,\n      error: ''\n    } }];\n  } else {\n    return [{ json: { ...inputData, error: result.body.detail || 'Caption burn failed', success: false } }];\n  }\n} catch (error) {\n  return [{ json: { ...inputData, error: error.message, success: false } }];\n}"},"id":"run-ffmpeg-caption","name":"Burn Captions","type":"n8n-nodes-base.code","typeVersion":2,"position":[1024,2480]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"caption-success","leftValue":"={{ $json.success }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-caption-success","name":"Caption Success?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1168,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input to handle', handled: true } }];\n}\n\nconst inputData = items[0].json;\n\nreturn [{\n  json: {\n    ...inputData,\n    caption_error_handled: true,\n    error_message: inputData.error || 'Caption burning failed'\n  }\n}];"},"id":"handle-caption-error","name":"Handle Caption Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[1392,2496]},{"parameters":{"content":"## Publish\nBlotato multi-platform publishing","height":140,"width":180,"color":4},"id":"note-publish","name":"Publish","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,2816]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\n\nreturn [{\n  json: {\n    asset_id: inputData.asset_id,\n    script_id: inputData.script_id,\n    content_idea_id: inputData.content_idea_id,\n    final_video_path: inputData.final_path,\n    file_size: inputData.file_size\n  }\n}];"},"id":"prepare-publish","name":"Prepare Publish Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,2848]},{"parameters":{"filePath":"={{ $json.final_video_path }}","dataPropertyName":"data"},"id":"read-final-video","name":"Read Final Video","type":"n8n-nodes-base.readBinaryFile","typeVersion":1,"position":[208,2848]},{"parameters":{"jsCode":"// Parse Dropbox shared link response and convert to direct download URL\nconst input = $input.first().json;\n\nlet videoUrl = '';\n\n// Check for share response\nif (input.share_response?.url) {\n  // Convert Dropbox share link to direct download\n  // https://www.dropbox.com/s/xxx/file.mp4?dl=0 -> https://dl.dropboxusercontent.com/s/xxx/file.mp4\n  videoUrl = input.share_response.url\n    .replace('www.dropbox.com', 'dl.dropboxusercontent.com')\n    .replace('?dl=0', '')\n    .replace('?dl=1', '');\n} else if (input.share_response?.error?.['.tag'] === 'shared_link_already_exists') {\n  // Link already exists - get it from the error response\n  const existingUrl = input.share_response.error.shared_link_already_exists?.metadata?.url;\n  if (existingUrl) {\n    videoUrl = existingUrl\n      .replace('www.dropbox.com', 'dl.dropboxusercontent.com')\n      .replace('?dl=0', '')\n      .replace('?dl=1', '');\n  } else {\n    throw new Error(`Shared link exists but URL not found: ${JSON.stringify(input.share_response)}`);\n  }\n} else if (input.share_error) {\n  throw new Error(`Dropbox share error: ${input.share_error}`);\n} else if (input.upload_error) {\n  throw new Error(`Dropbox upload error: ${input.upload_error}`);\n} else {\n  throw new Error(`Unexpected response: ${JSON.stringify(input)}`);\n}\n\nreturn [{\n  json: {\n    asset_id: input.asset_id,\n    script_id: input.script_id,\n    content_idea_id: input.content_idea_id,\n    final_video_path: input.final_video_path,\n    video_url: videoUrl,\n    hosted_url: videoUrl\n  }\n}];"},"id":"format-gcs-url","name":"Parse Upload Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[496,2848]},{"parameters":{"method":"POST","url":"https://backend.blotato.com/v2/posts/create","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"platforms\": {{ JSON.stringify($('Parse Upload Response').first().json.platforms || ['tiktok', 'instagram', 'youtube']) }},\n  \"content\": {\n    \"caption\": {{ JSON.stringify($('Parse Upload Response').first().json.caption || '') }},\n    \"video_url\": \"{{ $input.first().json.url || $('Parse Upload Response').first().json.video_url }}\"\n  },\n  \"schedule\": { \"type\": \"now\" },\n  \"options\": { \"auto_hashtags\": false, \"cross_post\": true }\n}","options":{"timeout":120000}},"id":"publish-blotato","name":"Publish (Blotato)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[640,2848],"credentials":{"httpHeaderAuth":{"id":"blotato","name":"blotato"}},"continueOnFail":true},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\n\n// Get data from upstream nodes\nconst uploadResponse = $('Parse Upload Response').first()?.json || {};\nconst publishData = $('Prepare Publish Data').first()?.json || {};\n\n// Check if Blotato publish failed (continueOnFail returns error info)\nconst hasError = inputData.error || inputData.message?.includes('not found') || inputData.statusCode === 404;\n\n// Common output structure\nconst result = {\n  asset_id: publishData.asset_id || uploadResponse.asset_id,\n  script_id: publishData.script_id || uploadResponse.script_id,\n  content_idea_id: publishData.content_idea_id || uploadResponse.content_idea_id,\n  video_url: uploadResponse.video_url || uploadResponse.hosted_url,\n  publish_success: !hasError,\n  publish_skipped: hasError,\n  publish_error: hasError ? 'Blotato credentials not configured' : null,\n  published_at: new Date().toISOString(),\n  // Platform fields (null when skipped)\n  tiktok_url: null,\n  tiktok_id: null,\n  ig_url: null,\n  ig_id: null,\n  yt_url: null,\n  yt_id: null,\n  linkedin_url: null,\n  linkedin_id: null,\n  x_url: null,\n  x_id: null,\n  facebook_url: null,\n  facebook_id: null,\n  threads_url: null,\n  threads_id: null,\n  pinterest_url: null,\n  pinterest_id: null\n};\n\nreturn [{ json: result }];"},"id":"parse-publish-response","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[784,2848]},{"parameters":{"method":"POST","url":"http://backend:8000/api/published","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"asset_id\": {{ $json.asset_id }},\n  \"tiktok_url\": {{ JSON.stringify($json.tiktok_url) }},\n  \"tiktok_id\": {{ JSON.stringify($json.tiktok_id) }},\n  \"ig_url\": {{ JSON.stringify($json.ig_url) }},\n  \"ig_id\": {{ JSON.stringify($json.ig_id) }},\n  \"yt_url\": {{ JSON.stringify($json.yt_url) }},\n  \"yt_id\": {{ JSON.stringify($json.yt_id) }},\n  \"linkedin_url\": {{ JSON.stringify($json.linkedin_url) }},\n  \"linkedin_id\": {{ JSON.stringify($json.linkedin_id) }},\n  \"x_url\": {{ JSON.stringify($json.x_url) }},\n  \"x_id\": {{ JSON.stringify($json.x_id) }},\n  \"facebook_url\": {{ JSON.stringify($json.facebook_url) }},\n  \"facebook_id\": {{ JSON.stringify($json.facebook_id) }},\n  \"threads_url\": {{ JSON.stringify($json.threads_url) }},\n  \"threads_id\": {{ JSON.stringify($json.threads_id) }},\n  \"pinterest_url\": {{ JSON.stringify($json.pinterest_url) }},\n  \"pinterest_id\": {{ JSON.stringify($json.pinterest_id) }}\n}","options":{}},"id":"save-publish-record","name":"Save Publish Record","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,2848]},{"parameters":{"method":"PATCH","url":"=http://backend:8000/api/content-ideas/{{ $('Parse Response').first().json.content_idea_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"status\": \"published\",\n  \"published_at\": {{ JSON.stringify($('Parse Response').first().json.published_at) }}\n}","options":{}},"id":"update-final-status","name":"Update Status Published","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1072,2848]},{"parameters":{"content":"## File Server\nServe audio/video files to external APIs","height":140,"width":180},"id":"note-file-server","name":"File Server","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1504,48]},{"parameters":{"path":"serve-audio/:script_id","responseMode":"responseNode","options":{}},"id":"webhook-serve-audio","name":"Serve Audio","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[1568,208],"webhookId":"2fc52be9-47ee-43eb-a327-3454606b35fa","onError":"continueRegularOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const fs = require('fs');\nconst scriptId = $input.first().json.params.script_id;\nconst filePath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n\ntry {\n  const buffer = fs.readFileSync(filePath);\n  return [{\n    json: $input.first().json,\n    binary: {\n      data: {\n        data: buffer.toString('base64'),\n        mimeType: 'audio/mpeg',\n        fileName: `${scriptId}_voice.mp3`\n      }\n    }\n  }];\n} catch (error) {\n  throw new Error(`Failed to read audio file: ${filePath}. Error: ${error.message}`);\n}"},"id":"read-audio-code-server","name":"Read Audio","type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,208]},{"parameters":{"respondWith":"binary","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"audio/mpeg"}]}}},"id":"respond-audio","name":"Return Audio","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2000,208]},{"parameters":{"path":"serve-video/:script_id","responseMode":"responseNode","options":{}},"id":"webhook-serve-video","name":"Serve Video","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[1568,384],"webhookId":"33394c8b-a4f9-4606-b522-2856840a5297","onError":"continueRegularOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const fs = require('fs');\nconst scriptId = $input.first().json.params.script_id;\nconst filePath = `/home/node/.n8n-files/assets/output/${scriptId}_final.mp4`;\n\ntry {\n  const buffer = fs.readFileSync(filePath);\n  return [{\n    json: $input.first().json,\n    binary: {\n      data: {\n        data: buffer.toString('base64'),\n        mimeType: 'video/mp4',\n        fileName: `${scriptId}_final.mp4`\n      }\n    }\n  }];\n} catch (error) {\n  throw new Error(`Failed to read video file: ${filePath}. Error: ${error.message}`);\n}"},"id":"read-video-file","name":"Read Video","type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,384]},{"parameters":{"respondWith":"binary","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"video/mp4"}]}}},"id":"respond-video","name":"Return Video","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2000,384]},{"parameters":{"method":"POST","url":"=https://upload.heygen.com/v1/asset?name={{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"binaryData","inputDataFieldName":"data","options":{}},"name":"Upload HeyGen Audio","id":"upload-heygen-audio-http","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1936,624],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"errorMessage":"HeyGen Generation Failed"},"id":"stop-heygen-error","name":"Stop on Failure","type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[1440,1888]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-custom-photo","leftValue":"={{ $('Prepare TTS Text').first().json.avatar_type }}","rightValue":"custom_photo","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-is-photo","name":"Is Talking Photo?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2112,624]},{"parameters":{"url":"={{ $('Prepare TTS Text').first().json.config_image_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"download-char-image","name":"Download Character Image","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2272,1392]},{"parameters":{"method":"POST","url":"https://upload.heygen.com/v1/talking_photo","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"image","parameterType":"formBinaryData","inputDataFieldName":"data"}]},"options":{}},"id":"upload-talking-photo","name":"Upload Talking Photo","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2432,1392],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// HeyGen video status values: waiting, pending, processing, completed, failed\n// Route to appropriate output based on status\nconst status = $input.item.json.data?.status;\n\n// Preserve all data from previous nodes for downstream use\nconst prevData = $('Extract Video ID').first().json;\nconst enrichedItem = {\n  json: {\n    ...prevData,\n    heygen_status: status,\n    video_url: $input.item.json.data?.video_url || null\n  }\n};\n\n// Output 0 = completed (ready to download)\n// Output 1 = still processing (retry)\n// Output 2 = failed (error)\nif (status === 'completed') {\n  return [enrichedItem, null, null];\n} else if (status === 'waiting' || status === 'pending' || status === 'processing') {\n  return [null, enrichedItem, null];\n} else {\n  // failed or unknown\n  return [null, null, enrichedItem];\n}"},"id":"route-status-switch","name":"Route Status","type":"n8n-nodes-base.code","typeVersion":2,"position":[944,1776]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\n\nconst items = $input.all();\nconst prevData = items[0].json;\n\n// Get data from previous nodes\nlet scriptId, sourceUrl, sourcePlatform;\n\ntry {\n  scriptId = $('Save Script').first().json.id;\n} catch (e) {\n  scriptId = prevData.script_id || 22;\n}\n\ntry {\n  const normalizeData = $('Normalize Idea').first().json;\n  sourceUrl = normalizeData.source_url;\n  sourcePlatform = normalizeData.source_platform;\n} catch (e) {\n  sourceUrl = prevData.source_url || '';\n  sourcePlatform = prevData.source_platform || 'unknown';\n}\n\nconst expectedPath = `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\n\n// Check if file exists\nif (fs.existsSync(expectedPath)) {\n  const stats = fs.statSync(expectedPath);\n  return [{\n    json: {\n      saved_path: expectedPath,\n      script_id: scriptId,\n      source_platform: sourcePlatform,\n      source_url: sourceUrl,\n      file_size: stats.size,\n      verified: true\n    }\n  }];\n}\n\n// Try to find any file with this prefix\nconst dir = '/home/node/.n8n-files/assets/videos/';\ntry {\n  const files = fs.readdirSync(dir).filter(f => f.startsWith(`${scriptId}_source`));\n  if (files.length > 0) {\n    const foundPath = `${dir}${files[0]}`;\n    const stats = fs.statSync(foundPath);\n    return [{\n      json: {\n        saved_path: foundPath,\n        script_id: scriptId,\n        source_platform: sourcePlatform,\n        source_url: sourceUrl,\n        file_size: stats.size,\n        verified: true\n      }\n    }];\n  }\n} catch (e) {\n  console.log('Error checking directory:', e.message);\n}\n\n// No file found - return with verified=false but don't throw\nreturn [{\n  json: {\n    saved_path: expectedPath,\n    script_id: scriptId,\n    source_platform: sourcePlatform,\n    source_url: sourceUrl,\n    verified: false,\n    error: 'Source video file not found'\n  }\n}];"},"id":"verify-download","name":"Verify Download","type":"n8n-nodes-base.code","typeVersion":2,"position":[288,928]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\nconst { execSync } = require('child_process');\n\nconst items = $input.all();\nconst prevData = items[0].json;\n\n// Get script ID from previous nodes\nlet scriptId;\ntry {\n  scriptId = $('Save Script').first().json.id;\n} catch (e) {\n  scriptId = prevData.script_id || 22;\n}\n\nlet sourceUrl;\ntry {\n  sourceUrl = $('Normalize Idea').first().json.source_url;\n} catch (e) {\n  sourceUrl = prevData.source_url || '';\n}\n\nconst outputPath = `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\n\n// Check if file already exists\nif (fs.existsSync(outputPath)) {\n  const stats = fs.statSync(outputPath);\n  if (stats.size > 1000) { // File exists and is not empty\n    console.log(`Source video already exists: ${outputPath} (${stats.size} bytes)`);\n    return [{\n      json: {\n        success: true,\n        skipped: true,\n        output_path: outputPath,\n        script_id: scriptId,\n        source_url: sourceUrl,\n        file_size: stats.size\n      }\n    }];\n  }\n}\n\n// Try to download with yt-dlp if available\ntry {\n  const cmd = `yt-dlp -f 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best' -o '${outputPath}' --no-playlist --merge-output-format mp4 '${sourceUrl}'`;\n  console.log(`Running: ${cmd}`);\n  const output = execSync(cmd, { encoding: 'utf-8', timeout: 300000 });\n  console.log(output);\n  \n  return [{\n    json: {\n      success: true,\n      skipped: false,\n      output_path: outputPath,\n      script_id: scriptId,\n      source_url: sourceUrl\n    }\n  }];\n} catch (error) {\n  // If yt-dlp fails or not found, create placeholder and continue\n  console.log(`Download failed (${error.message}), using placeholder`);\n  \n  // Check if file exists anyway (maybe partial download)\n  if (fs.existsSync(outputPath)) {\n    const stats = fs.statSync(outputPath);\n    if (stats.size > 1000) {\n      return [{\n        json: {\n          success: true,\n          skipped: true,\n          output_path: outputPath,\n          script_id: scriptId,\n          source_url: sourceUrl,\n          file_size: stats.size,\n          note: 'Using existing file after download failure'\n        }\n      }];\n    }\n  }\n  \n  // Return with error flag but don't throw - let pipeline continue\n  return [{\n    json: {\n      success: false,\n      error: error.message,\n      output_path: outputPath,\n      script_id: scriptId,\n      source_url: sourceUrl,\n      note: 'Download failed, no source video available'\n    }\n  }];\n}"},"id":"download-source-video","name":"Download Source Video","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,928]},{"id":"check-avatar-exists-early","name":"Avatar Already Exists?","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,1400],"parameters":{"jsCode":"// Check if avatar video already exists BEFORE uploading to HeyGen\n// Also check if there's an existing HeyGen video ID we can resume from\nconst fs = require('fs');\nconst ttsData = $('Prepare TTS Text').first().json;\nconst scriptId = ttsData.script_id;\nconst assetId = ttsData.asset_id;\nconst filePath = `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\n\nlet fileExists = false;\nlet heygenVideoId = null;\n\n// Check if local file exists\ntry {\n  fileExists = fs.existsSync(filePath);\n  console.log(`Avatar file check: ${filePath} exists=${fileExists}`);\n} catch (e) {\n  console.log(`Avatar file check error: ${e.message}`);\n}\n\n// Check database for existing heygen_video_id\ntry {\n  const response = await fetch(`http://backend:8000/api/assets/${assetId}`);\n  if (response.ok) {\n    const asset = await response.json();\n    heygenVideoId = asset.heygen_video_id || null;\n    console.log(`Database check: asset ${assetId} has heygen_video_id=${heygenVideoId}`);\n  }\n} catch (e) {\n  console.log(`Database check error: ${e.message}`);\n}\n\nconst inputData = $input.first().json;\nconst binaryData = $input.first().binary;\n\nreturn [{ \n    json: { \n        ...inputData,\n        ...ttsData,\n        avatar_exists: fileExists,\n        avatar_path: filePath,\n        heygen_video_id: heygenVideoId,\n        has_heygen_id: !!heygenVideoId\n    },\n    binary: binaryData\n}];"}},{"id":"mock-heygen-data","name":"Use Existing Avatar","type":"n8n-nodes-base.code","typeVersion":2,"position":[1700,1300],"parameters":{"jsCode":"// Mock the data that would come from HeyGen for testing\n// Also pass through source_video_path and voice_path for FFmpeg\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input data', success: false } }];\n}\nconst inputData = items[0].json;\nconst scriptId = inputData.script_id;\n\n// Get source video path from earlier in pipeline\nlet sourceVideoPath;\ntry {\n  sourceVideoPath = $('Verify Download').first().json.saved_path;\n} catch (e) {\n  sourceVideoPath = `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\n}\n\n// Get voice path\nlet voicePath;\ntry {\n  voicePath = $('Update Asset Voice').first().json.voiceover_path;\n} catch (e) {\n  voicePath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n}\n\n// Get settings from Fetch Settings node\nlet settings;\ntry {\n  settings = $('Fetch Settings').first().json.settings;\n} catch (e) {\n  settings = {\n    audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n    video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow' }\n  };\n}\n\nreturn [{\n  json: {\n    asset_id: inputData.asset_id,\n    script_id: scriptId,\n    content_idea_id: inputData.content_idea_id,\n    avatar_path: `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`,\n    source_video_path: sourceVideoPath,\n    voice_path: voicePath,\n    settings: settings,\n    heygen_video_id: 'test-mock-id',\n    retry_count: 0,\n    max_retries: 20\n  }\n}];"}},{"id":"blotato-media-upload","name":"Blotato Media Upload","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[560,2848],"parameters":{"method":"POST","url":"https://backend.blotato.com/v2/media","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ url: $json.video_url }) }}","options":{"timeout":120000}},"credentials":{"httpHeaderAuth":{"id":"blotato","name":"blotato"}}},{"id":"dropbox-upload-code","name":"Upload to Dropbox","type":"n8n-nodes-base.code","typeVersion":2,"position":[352,2848],"parameters":{"mode":"runOnceForAllItems","jsCode":"const https = require('https');\nconst fs = require('fs');\nconst path = require('path');\n\nconst DROPBOX_TOKEN = 'sl.u.AGPRUxqBQeFd_BpLa6hBZfho-ffgtPK3ffiMqjskEb05TTaW0ZyKXDXAj1_I07xP_sEjJF8dbfPVV4sTRw2ZVwdHc4HlmGsa_RWgEE-4SrqSONBIBBdLsKGGBh7qVT2ZjRSgF1X72O6bBn1veBBFG4wmq8mVgj1KuX-fTKX2xEUfZfNkA_FzYiDQYu3MbbjFcPV_KAoMWOXDhFiW3u5pVGbhVILJWduvc2n1-wvhPBdJwAJyMWhONpr3UEh07MGjMtiqxspdNVvbgXBEVMf-8SNf3yR6j-Q29UOFBS10xz7N-OxgnW0A2rYUlJ-9WiQztjs-yVNAiWCO0MEq89ogxuvqJdm5kCwx6V4AC3WNAgnXLOq3Ccv5uD_o8DZgO9CQOyuQcaCnHm4TWaJ-RbYl5W1jTwzDudKHKTGu1aAgqB6Hyo8pLSUV2Oz6g_rhdbL4p7QiPTdbiVuwr0xFOjKALbjmdjS_kvByYxljlJDC8SfEOi_w1TEsdUAFmgukizlxI8hnFCm0gyBQx1NxTKxzGF6u9Mh19vSf4lhlQke4CMeG40xAr81LoNn_EPUdDo4gGQlk3p0maFA9a12HcPPc-URtbUhQFac5HR3s5THLKhjCh9wHgLYp0P2Ps9N47_1J4IOnxB4vQNCxAZ_yYauKjJTS8_9M4ZHD7xlAwepPLPliYfF1nDllggYTN7Me0H4Ytb7gy6Px6geVRrISgKCFUkhKyNJZW3lBzRrIfaG_4c-iGHPeXEjENK8dTZfHKMs4n5f8EAKoz4Qa1FJiwxwNvuXJJv_1yctniVWePtEq_wpqeKC6vRZ_WRBGwRYnGumcc7UJ83g2VxOcBrqxmeCSoc_Y16LW6fDqbwYxu8VhEye9k_d6MaRcXNSCzZD9xLYA2e8hXrFk3dR1--By6vTIf7W7vP75hpcWs78H2_N5eYlcIUH_3DrhJ8Tpg_jSq0I60PdRILUncp4SrjvpO85ekn8hsCgS2f3ziLGPpuIrieGc4ANKXBgBxpdR4W1AKzKCh9APUPuJdQvXDS8GzN4Nzyx9Rh8wxBgnlWhT_ik8odSicEALvq2N07txxOQocHza81MKhxJzzAlBQ2yQDDysf31YKEgbJJe_45W42a6qitns-gaqvkstG4o6xHjchxdA0zJp8dI_A93BtiB9TQhXxv3yc0LDeChgcSdh6VMJrSgpY-ukNVnxQRJoCkDmiXwlyvFjHVLbyXvW31eE1j4zVUNJ9KzAP-8U9-wUwPHKO1cZN1h-tI_neYQ7Z7RkbASadsk97W9SjOwA3JShnWaNZ6yBHL1dgGqwKOESQ5RZK6HTOQ';\n\nconst publishData = $('Prepare Publish Data').first().json;\nconst videoPath = publishData.final_video_path;\nconst scriptId = publishData.script_id;\n\n// Read file\nconst fileBuffer = fs.readFileSync(videoPath);\nconst dropboxPath = `/n8n-videos/${scriptId}_final.mp4`;\n\nreturn new Promise((resolve, reject) => {\n  const options = {\n    hostname: 'content.dropboxapi.com',\n    port: 443,\n    path: '/2/files/upload',\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${DROPBOX_TOKEN}`,\n      'Content-Type': 'application/octet-stream',\n      'Dropbox-API-Arg': JSON.stringify({\n        path: dropboxPath,\n        mode: 'overwrite',\n        autorename: false,\n        mute: false\n      })\n    },\n    timeout: 300000\n  };\n\n  const req = https.request(options, (res) => {\n    let data = '';\n    res.on('data', (chunk) => data += chunk);\n    res.on('end', () => {\n      try {\n        const parsed = JSON.parse(data);\n        resolve([{ json: { ...publishData, dropbox_path: dropboxPath, upload_response: parsed } }]);\n      } catch (e) {\n        resolve([{ json: { ...publishData, dropbox_path: dropboxPath, upload_error: data } }]);\n      }\n    });\n  });\n\n  req.on('error', (e) => resolve([{ json: { ...publishData, upload_error: e.message } }]));\n  req.on('timeout', () => {\n    req.destroy();\n    resolve([{ json: { ...publishData, upload_error: 'timeout' } }]);\n  });\n\n  req.write(fileBuffer);\n  req.end();\n});"}},{"id":"dropbox-share-code","name":"Create Share Link","type":"n8n-nodes-base.code","typeVersion":2,"position":[496,2848],"parameters":{"mode":"runOnceForAllItems","jsCode":"const https = require('https');\n\nconst DROPBOX_TOKEN = 'sl.u.AGPRUxqBQeFd_BpLa6hBZfho-ffgtPK3ffiMqjskEb05TTaW0ZyKXDXAj1_I07xP_sEjJF8dbfPVV4sTRw2ZVwdHc4HlmGsa_RWgEE-4SrqSONBIBBdLsKGGBh7qVT2ZjRSgF1X72O6bBn1veBBFG4wmq8mVgj1KuX-fTKX2xEUfZfNkA_FzYiDQYu3MbbjFcPV_KAoMWOXDhFiW3u5pVGbhVILJWduvc2n1-wvhPBdJwAJyMWhONpr3UEh07MGjMtiqxspdNVvbgXBEVMf-8SNf3yR6j-Q29UOFBS10xz7N-OxgnW0A2rYUlJ-9WiQztjs-yVNAiWCO0MEq89ogxuvqJdm5kCwx6V4AC3WNAgnXLOq3Ccv5uD_o8DZgO9CQOyuQcaCnHm4TWaJ-RbYl5W1jTwzDudKHKTGu1aAgqB6Hyo8pLSUV2Oz6g_rhdbL4p7QiPTdbiVuwr0xFOjKALbjmdjS_kvByYxljlJDC8SfEOi_w1TEsdUAFmgukizlxI8hnFCm0gyBQx1NxTKxzGF6u9Mh19vSf4lhlQke4CMeG40xAr81LoNn_EPUdDo4gGQlk3p0maFA9a12HcPPc-URtbUhQFac5HR3s5THLKhjCh9wHgLYp0P2Ps9N47_1J4IOnxB4vQNCxAZ_yYauKjJTS8_9M4ZHD7xlAwepPLPliYfF1nDllggYTN7Me0H4Ytb7gy6Px6geVRrISgKCFUkhKyNJZW3lBzRrIfaG_4c-iGHPeXEjENK8dTZfHKMs4n5f8EAKoz4Qa1FJiwxwNvuXJJv_1yctniVWePtEq_wpqeKC6vRZ_WRBGwRYnGumcc7UJ83g2VxOcBrqxmeCSoc_Y16LW6fDqbwYxu8VhEye9k_d6MaRcXNSCzZD9xLYA2e8hXrFk3dR1--By6vTIf7W7vP75hpcWs78H2_N5eYlcIUH_3DrhJ8Tpg_jSq0I60PdRILUncp4SrjvpO85ekn8hsCgS2f3ziLGPpuIrieGc4ANKXBgBxpdR4W1AKzKCh9APUPuJdQvXDS8GzN4Nzyx9Rh8wxBgnlWhT_ik8odSicEALvq2N07txxOQocHza81MKhxJzzAlBQ2yQDDysf31YKEgbJJe_45W42a6qitns-gaqvkstG4o6xHjchxdA0zJp8dI_A93BtiB9TQhXxv3yc0LDeChgcSdh6VMJrSgpY-ukNVnxQRJoCkDmiXwlyvFjHVLbyXvW31eE1j4zVUNJ9KzAP-8U9-wUwPHKO1cZN1h-tI_neYQ7Z7RkbASadsk97W9SjOwA3JShnWaNZ6yBHL1dgGqwKOESQ5RZK6HTOQ';\n\nconst input = $input.first().json;\nconst dropboxPath = input.dropbox_path;\n\n// Helper function to make HTTPS requests\nfunction makeRequest(path, body) {\n  return new Promise((resolve, reject) => {\n    const bodyStr = JSON.stringify(body);\n    const options = {\n      hostname: 'api.dropboxapi.com',\n      port: 443,\n      path: path,\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${DROPBOX_TOKEN}`,\n        'Content-Type': 'application/json',\n        'Content-Length': Buffer.byteLength(bodyStr)\n      },\n      timeout: 30000\n    };\n\n    const req = https.request(options, (res) => {\n      let data = '';\n      res.on('data', (chunk) => data += chunk);\n      res.on('end', () => {\n        try {\n          resolve(JSON.parse(data));\n        } catch (e) {\n          reject(new Error(data));\n        }\n      });\n    });\n\n    req.on('error', reject);\n    req.write(bodyStr);\n    req.end();\n  });\n}\n\n// Try to create a shared link\nconst createResponse = await makeRequest('/2/sharing/create_shared_link_with_settings', {\n  path: dropboxPath,\n  settings: { requested_visibility: 'public' }\n});\n\n// If link was created successfully, return it\nif (createResponse.url) {\n  return [{ json: { ...input, share_response: createResponse } }];\n}\n\n// If link already exists, fetch existing links\nif (createResponse.error?.['.tag'] === 'shared_link_already_exists') {\n  const listResponse = await makeRequest('/2/sharing/list_shared_links', {\n    path: dropboxPath,\n    direct_only: true\n  });\n\n  if (listResponse.links && listResponse.links.length > 0) {\n    // Return the first existing link\n    return [{ json: { ...input, share_response: { url: listResponse.links[0].url } } }];\n  }\n}\n\n// Return original response if nothing worked\nreturn [{ json: { ...input, share_response: createResponse } }];"}},{"id":"fetch-settings","name":"Fetch Settings","type":"n8n-nodes-base.code","typeVersion":2,"position":[780,224],"parameters":{"mode":"runOnceForAllItems","jsCode":"// Fetch all settings from backend API\nconst http = require('http');\n\nconst items = $input.all();\nconst inputData = items[0]?.json || {};\n\nreturn new Promise((resolve, reject) => {\n  const options = {\n    hostname: 'backend',\n    port: 8000,\n    path: '/api/settings/all',\n    method: 'GET',\n    timeout: 10000\n  };\n\n  const req = http.request(options, (res) => {\n    let data = '';\n    res.on('data', (chunk) => data += chunk);\n    res.on('end', () => {\n      try {\n        const settings = JSON.parse(data);\n        resolve([{ json: { ...inputData, settings } }]);\n      } catch (e) {\n        // Use defaults if API fails\n        resolve([{ json: {\n          ...inputData,\n          settings: {\n            audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n            video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow', greenscreen_enabled: true, greenscreen_color: '#00FF00' }\n          }\n        }}]);\n      }\n    });\n  });\n\n  req.on('error', () => {\n    // Use defaults if API fails\n    resolve([{ json: {\n      ...inputData,\n      settings: {\n        audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n        video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow', greenscreen_enabled: true, greenscreen_color: '#00FF00' }\n      }\n    }}]);\n  });\n\n  req.on('timeout', () => {\n    req.destroy();\n    resolve([{ json: {\n      ...inputData,\n      settings: {\n        audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n        video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow', greenscreen_enabled: true, greenscreen_color: '#00FF00' }\n      }\n    }}]);\n  });\n\n  req.end();\n})"}},{"id":"route-heygen-logic","name":"Route HeyGen Logic","type":"n8n-nodes-base.code","typeVersion":2,"position":[1550,1400],"parameters":{"mode":"runOnceForEachItem","jsCode":"// Route based on avatar state:\n// Output 0: File exists -> Use Existing Avatar (skip HeyGen entirely)\n// Output 1: HeyGen ID exists but no file -> Resume polling (check status)\n// Output 2: No file, no ID -> Create new HeyGen video\n\nconst item = $input.item.json;\nconst fileExists = item.avatar_exists;\nconst heygenId = item.heygen_video_id;\n\nif (fileExists) {\n  // Avatar file already exists, skip HeyGen\n  console.log('Route: File exists, skipping HeyGen');\n  return [{json: item}, null, null];\n} else if (heygenId) {\n  // HeyGen ID exists but file not downloaded yet - resume polling\n  console.log(`Route: Resuming HeyGen polling for video ${heygenId}`);\n  return [null, {json: item}, null];\n} else {\n  // No file, no ID - create new HeyGen video\n  console.log('Route: Creating new HeyGen video');\n  return [null, null, {json: item}];\n}"}},{"id":"resume-heygen-check","name":"Resume HeyGen Check","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1700,1500],"parameters":{"method":"GET","url":"=https://api.heygen.com/v1/video_status.get?video_id={{ $json.heygen_video_id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"options":{}},"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"id":"route-resume-status","name":"Route Resume Status","type":"n8n-nodes-base.code","typeVersion":2,"position":[1850,1500],"parameters":{"mode":"runOnceForEachItem","jsCode":"// Route resumed HeyGen check result\n// Output 0: Completed -> Download Avatar\n// Output 1: Processing -> Wait & Retry\n// Output 2: Failed -> Stop on Failure\n\nconst item = $input.item.json;\nconst prevData = $('Route HeyGen Logic').first().json;\nconst status = item.data?.status;\n\nconst enrichedItem = {\n  ...prevData,\n  heygen_status: status,\n  video_url: item.data?.video_url || null,\n  retry_count: 0,\n  max_retries: 20\n};\n\nconsole.log(`Resume status check: ${status}`);\n\nif (status === 'completed') {\n  return [{json: enrichedItem}, null, null];\n} else if (status === 'waiting' || status === 'pending' || status === 'processing') {\n  return [null, {json: enrichedItem}, null];\n} else {\n  // failed or unknown\n  return [null, null, {json: enrichedItem}];\n}"}}],"connections":{"Daily 6am Scrape":{"main":[[{"node":"Parse Scrape Params","type":"main","index":0}]]},"Scrape Webhook":{"main":[[{"node":"Parse Scrape Params","type":"main","index":0}]]},"Parse Scrape Params":{"main":[[{"node":"TikTok?","type":"main","index":0},{"node":"Instagram?","type":"main","index":0},{"node":"YouTube?","type":"main","index":0}]]},"TikTok?":{"main":[[{"node":"Apify TikTok","type":"main","index":0}],[{"node":"Skip TikTok","type":"main","index":0}]]},"Instagram?":{"main":[[{"node":"Apify Instagram Reels","type":"main","index":0}],[{"node":"Skip Instagram","type":"main","index":0}]]},"YouTube?":{"main":[[{"node":"Apify YouTube","type":"main","index":0}],[{"node":"Skip YouTube","type":"main","index":0}]]},"Apify TikTok":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Apify Instagram Reels":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Apify YouTube":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Skip TikTok":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Skip Instagram":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Skip YouTube":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Merge Results":{"main":[[{"node":"Normalize Data","type":"main","index":0}]]},"Normalize Data":{"main":[[{"node":"Analyze with Grok","type":"main","index":0}]]},"Analyze with Grok":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Process & Save Trends","type":"main","index":0}]]},"Process & Save Trends":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Get Approved Idea","type":"main","index":0}]]},"Respond Immediately":{"main":[[{"node":"Get Approved Idea","type":"main","index":0},{"node":"Specific ID?","type":"main","index":0}]]},"Get Approved Idea":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Specific ID?":{"1":[[{"node":"Respond Immediately","type":"1","index":0}]],"main":[[{"node":"Get Specific Idea","type":"main","index":0}],[{"node":"Merge","type":"main","index":1}]]},"Get Specific Idea":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Normalize Idea","type":"main","index":0}]]},"Normalize Idea":{"main":[[{"node":"Fetch Settings","type":"main","index":0}]]},"Has Content?":{"main":[[{"node":"Update Status","type":"main","index":0}],[{"node":"No Content","type":"main","index":0}]]},"Update Status":{"main":[[{"node":"Generate Script (Grok)","type":"main","index":0}]]},"Generate Script (Grok)":{"main":[[{"node":"Parse Script","type":"main","index":0}]]},"Parse Script":{"main":[[{"node":"Save Script","type":"main","index":0}]]},"Save Script":{"main":[[{"node":"Create Asset Record","type":"main","index":0}]]},"Get Character Config":{"main":[[{"node":"Prepare TTS Text","type":"main","index":0}]]},"Prepare TTS Text":{"main":[[{"node":"Check Voice Exists","type":"main","index":0}]]},"Check Voice Exists":{"main":[[{"node":"Voice Exists?","type":"main","index":0}]]},"Voice Exists?":{"main":[[{"node":"Get Duration","type":"main","index":0}],[{"node":"Generate Voice (ElevenLabs)","type":"main","index":0}]]},"Generate Voice (ElevenLabs)":{"main":[[{"node":"Save Voice","type":"main","index":0}]]},"Save Voice":{"main":[[{"node":"Get Duration","type":"main","index":0}]]},"Get Duration":{"main":[[{"node":"Update Asset Voice","type":"main","index":0}]]},"Update Asset Voice":{"main":[[{"node":"Read Audio File","type":"main","index":0}]]},"Prepare HeyGen Data":{"main":[[{"node":"Check Video Exists","type":"main","index":0}]]},"Check Video Exists":{"main":[[{"node":"Video Exists?","type":"main","index":0}]]},"Video Exists?":{"main":[[{"node":"Build FFmpeg Command","type":"main","index":0}],[{"node":"Create HeyGen Video","type":"main","index":0}]]},"Create HeyGen Video":{"main":[[{"node":"Extract Video ID","type":"main","index":0}]]},"Extract Video ID":{"main":[[{"node":"Wait 30s","type":"main","index":0}]]},"Wait 30s":{"main":[[{"node":"Check Status","type":"main","index":0}]]},"Check Status":{"main":[[{"node":"Route Status","type":"main","index":0}]]},"Increment Retry":{"main":[[{"node":"Wait & Retry","type":"main","index":0}]]},"Wait & Retry":{"main":[[{"node":"Check Status","type":"main","index":0}]]},"Download Avatar":{"main":[[{"node":"Save Avatar","type":"main","index":0}]]},"Save Avatar":{"main":[[{"node":"Build FFmpeg Command","type":"main","index":0}]]},"Build FFmpeg Command":{"main":[[{"node":"Run FFmpeg","type":"main","index":0}]]},"Run FFmpeg":{"main":[[{"node":"Success?","type":"main","index":0}]]},"Success?":{"main":[[{"node":"Prepare Whisper","type":"main","index":0}],[{"node":"Handle Error","type":"main","index":0}]]},"Prepare Whisper":{"main":[[{"node":"Read Audio for Whisper","type":"main","index":0}]]},"Read Audio for Whisper":{"main":[[{"node":"Whisper Transcribe","type":"main","index":0}]]},"Whisper Transcribe":{"main":[[{"node":"Parse Whisper Response","type":"main","index":0}]]},"Parse Whisper Response":{"main":[[{"node":"Save SRT","type":"main","index":0}]]},"Save SRT":{"main":[[{"node":"Build Caption Cmd","type":"main","index":0}]]},"Build Caption Cmd":{"main":[[{"node":"Burn Captions","type":"main","index":0}]]},"Burn Captions":{"main":[[{"node":"Caption Success?","type":"main","index":0}]]},"Caption Success?":{"main":[[{"node":"Prepare Publish Data","type":"main","index":0}],[{"node":"Handle Caption Error","type":"main","index":0}]]},"Prepare Publish Data":{"main":[[{"node":"Read Final Video","type":"main","index":0}]]},"Publish (Blotato)":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"Save Publish Record","type":"main","index":0}]]},"Save Publish Record":{"main":[[{"node":"Update Status Published","type":"main","index":0}]]},"Serve Audio":{"main":[[{"node":"Read Audio","type":"main","index":0}]]},"Read Audio":{"main":[[{"node":"Return Audio","type":"main","index":0}]]},"Serve Video":{"main":[[{"node":"Read Video","type":"main","index":0}]]},"Read Video":{"main":[[{"node":"Return Video","type":"main","index":0}]]},"Upload HeyGen Audio":{"main":[[{"node":"Is Talking Photo?","type":"main","index":0}]]},"Is Talking Photo?":{"main":[[{"node":"Download Character Image","type":"main","index":0}],[{"node":"Prepare HeyGen Data","type":"main","index":0}]]},"Download Character Image":{"main":[[{"node":"Upload Talking Photo","type":"main","index":0}]]},"Upload Talking Photo":{"main":[[{"node":"Prepare HeyGen Data","type":"main","index":0}]]},"Route Status":{"main":[[{"node":"Download Avatar","type":"main","index":0}],[{"node":"Increment Retry","type":"main","index":0}],[{"node":"Stop on Failure","type":"main","index":0}]]},"Verify Download":{"main":[[{"node":"Get Character Config","type":"main","index":0}]]},"Create Asset Record":{"main":[[{"node":"Download Source Video","type":"main","index":0}]]},"Download Source Video":{"main":[[{"node":"Verify Download","type":"main","index":0}]]},"Read Audio File":{"main":[[{"node":"Avatar Already Exists?","type":"main","index":0}]]},"Use Existing Avatar":{"main":[[{"node":"Build FFmpeg Command","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Respond Immediately","type":"main","index":0}]]},"Parse Upload Response":{"main":[[{"node":"Blotato Media Upload","type":"main","index":0}]]},"Blotato Media Upload":{"main":[[{"node":"Publish (Blotato)","type":"main","index":0}]]},"Read Final Video":{"main":[[{"node":"Upload to Dropbox","type":"main","index":0}]]},"Upload to Dropbox":{"main":[[{"node":"Create Share Link","type":"main","index":0}]]},"Create Share Link":{"main":[[{"node":"Parse Upload Response","type":"main","index":0}]]},"Fetch Settings":{"main":[[{"node":"Has Content?","type":"main","index":0}]]},"Avatar Already Exists?":{"main":[[{"node":"Route HeyGen Logic","type":"main","index":0}]]},"Route HeyGen Logic":{"main":[[{"node":"Use Existing Avatar","type":"main","index":0}],[{"node":"Resume HeyGen Check","type":"main","index":0}],[{"node":"Upload HeyGen Audio","type":"main","index":0}]]},"Resume HeyGen Check":{"main":[[{"node":"Route Resume Status","type":"main","index":0}]]},"Route Resume Status":{"main":[[{"node":"Download Avatar","type":"main","index":0}],[{"node":"Increment Retry","type":"main","index":0}],[{"node":"Stop on Failure","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Daily 6am Scrape":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"fbc654f5-62ae-47d5-9b7d-24e02adc1fea","activeVersionId":"fbc654f5-62ae-47d5-9b7d-24e02adc1fea","versionCounter":623,"triggerCount":5,"shared":[{"updatedAt":"2026-01-08T05:43:31.306Z","createdAt":"2026-01-08T05:43:31.306Z","role":"workflow:owner","workflowId":"LNpBI12tR5p3NX3g","projectId":"FzjwLT9htkvV5HtJ","project":{"updatedAt":"2026-01-07T01:58:14.924Z","createdAt":"2026-01-07T01:45:13.914Z","id":"FzjwLT9htkvV5HtJ","name":"Cameron Anderson <cameronsaddress@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"a0773c81-ae88-49d0-b490-6bd27e8c7405","projectRelations":[{"updatedAt":"2026-01-07T01:45:13.914Z","createdAt":"2026-01-07T01:45:13.914Z","userId":"a0773c81-ae88-49d0-b490-6bd27e8c7405","projectId":"FzjwLT9htkvV5HtJ","user":{"updatedAt":"2026-01-09T16:27:04.608Z","createdAt":"2026-01-07T01:45:12.900Z","id":"a0773c81-ae88-49d0-b490-6bd27e8c7405","email":"cameronsaddress@gmail.com","firstName":"Cameron","lastName":"Anderson","personalizationAnswers":{"version":"v4","personalization_survey_submitted_at":"2026-01-07T01:58:22.545Z","personalization_survey_n8n_version":"2.2.4","companyType":"personal","reportedSource":"twitter"},"settings":{"userActivated":true,"firstSuccessfulWorkflowId":"XRDnwbe5AOWufC8J","userActivatedAt":1767751251036},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-01-09","isPending":false}}]}}],"tags":[],"activeVersion":{"updatedAt":"2026-01-09T22:59:11.324Z","createdAt":"2026-01-09T22:59:11.324Z","versionId":"fbc654f5-62ae-47d5-9b7d-24e02adc1fea","workflowId":"LNpBI12tR5p3NX3g","nodes":[{"parameters":{"content":"## 1. SCRAPE\nDiscover trending content from TikTok, Instagram, YouTube","width":280,"color":7},"id":"note-scrape","name":"Scrape Section","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1600,-96]},{"parameters":{"rule":{"interval":[{"triggerAtHour":6}]}},"id":"scrape-schedule","name":"Daily 6am Scrape","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1568,64]},{"parameters":{"httpMethod":"POST","path":"scrape-trends","responseMode":"responseNode","options":{}},"id":"scrape-webhook","name":"Scrape Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1568,240],"webhookId":"scrape-trends","onError":"continueRegularOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse incoming niche/platform parameters\nconst body = $input.first().json.body || $input.first().json;\n\n// Defaults\nconst niche = body.niche || 'real estate';\nconst hashtags = body.hashtags || ['realestate', 'realtor', 'homebuying', 'firsttimehomebuyer'];\nconst platforms = body.platforms || ['tiktok', 'instagram'];\nconst timeRange = body.time_range || '24h';\nconst resultsPerPlatform = body.results_per_platform || 50;\n\n// Build search terms from niche\nconst nicheTerms = niche.split(/[,;]+/).map(t => t.trim()).filter(t => t);\n\nreturn [{\n  json: {\n    niche,\n    nicheTerms,\n    hashtags,\n    platforms,\n    timeRange,\n    resultsPerPlatform,\n    scrapeStartedAt: new Date().toISOString()\n  }\n}];"},"id":"scrape-parse-params","name":"Parse Scrape Params","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1344,160]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"tiktok-check","leftValue":"={{ $json.platforms.includes('tiktok') }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-tiktok","name":"TikTok?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1120,-48]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"instagram-check","leftValue":"={{ $json.platforms.includes('instagram') }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-instagram","name":"Instagram?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1120,160]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"youtube-check","leftValue":"={{ $json.platforms.includes('youtube') }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-youtube","name":"YouTube?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1120,368]},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/clockworks~free-tiktok-scraper/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"hashtags\": {{ JSON.stringify($('Parse Scrape Params').first().json.hashtags) }},\n  \"resultsPerPage\": {{ $('Parse Scrape Params').first().json.resultsPerPlatform }}\n}","options":{"timeout":180000}},"id":"apify-tiktok","name":"Apify TikTok","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-864,-144],"credentials":{"httpHeaderAuth":{"id":"apify","name":"apify"}}},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/apify~instagram-hashtag-scraper/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"hashtags\": {{ JSON.stringify($('Parse Scrape Params').first().json.hashtags) }},\n  \"resultsType\": \"reels\",\n  \"resultsLimit\": {{ $('Parse Scrape Params').first().json.resultsPerPlatform }}\n}","options":{"timeout":180000}},"id":"apify-instagram","name":"Apify Instagram Reels","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-864,144],"credentials":{"httpHeaderAuth":{"id":"apify","name":"apify"}}},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/apify~youtube-scraper/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"searchKeywords\": {{ JSON.stringify($('Parse Scrape Params').first().json.nicheTerms) }},\n  \"sort\": \"relevance\",\n  \"maxResults\": {{ $('Parse Scrape Params').first().json.resultsPerPlatform }}\n}","options":{"timeout":180000}},"id":"apify-youtube","name":"Apify YouTube","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-864,432],"credentials":{"httpHeaderAuth":{"id":"apify","name":"apify"}}},{"parameters":{},"id":"skip-tiktok","name":"Skip TikTok","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-864,-288]},{"parameters":{},"id":"skip-instagram","name":"Skip Instagram","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-864,16]},{"parameters":{},"id":"skip-youtube","name":"Skip YouTube","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-864,304]},{"parameters":{},"id":"scrape-merge","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-608,160]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Normalize scraped items from different platforms\nconst items = $input.all();\nconst params = $('Parse Scrape Params').first().json;\nconst normalized = [];\n\nfor (const item of items) {\n  const data = item.json;\n  if (!data || typeof data !== 'object') continue;\n  \n  // Skip empty arrays or merge placeholders\n  if (Array.isArray(data) && data.length === 0) continue;\n  \n  // TikTok format\n  if (data.webVideoUrl || data.videoUrl) {\n    normalized.push({\n      platform: 'tiktok',\n      url: data.webVideoUrl || data.videoUrl,\n      title: data.text || data.desc || '',\n      views: data.playCount || 0,\n      likes: data.diggCount || 0,\n      comments: data.commentCount || 0,\n      shares: data.shareCount || 0,\n      engagement: (data.diggCount || 0) + (data.commentCount || 0) + (data.shareCount || 0),\n      author: data.authorMeta?.name || data.author || '',\n      created: data.createTime || null,\n      thumbnail: data.covers?.default || data.videoMeta?.coverUrl || ''\n    });\n  }\n  // Instagram Reels format\n  else if (data.url && (data.url.includes('instagram') || data.type === 'Reel')) {\n    normalized.push({\n      platform: 'instagram',\n      url: data.url || data.inputUrl,\n      title: data.caption || data.text || '',\n      views: data.playCount || data.videoPlayCount || 0,\n      likes: data.likesCount || data.likes || 0,\n      comments: data.commentsCount || data.comments || 0,\n      shares: 0,\n      engagement: (data.likesCount || data.likes || 0) + (data.commentsCount || data.comments || 0),\n      author: data.ownerUsername || data.author || '',\n      created: data.timestamp || null,\n      thumbnail: data.displayUrl || data.thumbnail || ''\n    });\n  }\n  // YouTube format\n  else if (data.url && data.url.includes('youtube')) {\n    normalized.push({\n      platform: 'youtube',\n      url: data.url,\n      title: data.title || '',\n      views: data.viewCount || 0,\n      likes: data.likes || 0,\n      comments: data.comments || 0,\n      shares: 0,\n      engagement: (data.likes || 0) + (data.comments || 0),\n      author: data.channelName || data.author || '',\n      created: data.uploadDate || null,\n      thumbnail: data.thumbnailUrl || ''\n    });\n  }\n}\n\n// Sort by engagement (highest first)\nnormalized.sort((a, b) => b.engagement - a.engagement);\n\n// Add metadata\nconst output = {\n  niche: params.niche,\n  platforms: params.platforms,\n  scrapedAt: params.scrapeStartedAt,\n  totalResults: normalized.length,\n  results: normalized\n};\n\nreturn [{ json: output }];"},"id":"scrape-normalize","name":"Normalize Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,160]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"HTTP-Referer","value":"http://100.83.153.43:5678"},{"name":"X-Title","value":"n8n-trend-analyzer"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  model: 'x-ai/grok-4.1-fast',\n  messages: [\n    {\n      role: 'system',\n      content: `You analyze trending social media content to find viral video ideas for a content creator.\\n\\nTarget niche: ${$json.niche}\\n\\nFor each piece of content, determine:\\n1. viral_score (1-10): How viral/engaging is this content?\\n2. pillar: One of: market_intelligence, educational_tips, lifestyle_local, brand_humanization\\n3. suggested_hook: A compelling hook to recreate this content\\n4. why_viral: Brief explanation of what makes it work\\n5. adaptable: true/false - Can this be adapted for the target niche?\\n\\nPILLAR DEFINITIONS:\\n- market_intelligence: Data, trends, market analysis, pricing, investment\\n- educational_tips: How-tos, tutorials, tips, process explanations\\n- lifestyle_local: Community, local events, lifestyle content\\n- brand_humanization: Personal stories, behind-the-scenes, relatable moments\\n\\nReturn JSON: { \"analyzed\": [{ \"url\", \"platform\", \"title\", \"views\", \"likes\", \"viral_score\", \"pillar\", \"suggested_hook\", \"why_viral\", \"adaptable\" }] }\\n\\nOnly include items with viral_score >= 6. Sort by viral_score descending.`\n    },\n    {\n      role: 'user',\n      content: `Analyze these ${$json.totalResults} trending items and identify the best content ideas:\\n\\n${JSON.stringify($json.results.slice(0, 30))}`\n    }\n  ],\n  temperature: 0.3,\n  max_tokens: 4000,\n  response_format: { type: 'json_object' }\n} }}","options":{"timeout":90000}},"id":"scrape-analyze-grok","name":"Analyze with Grok","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-160,160],"credentials":{"httpHeaderAuth":{"id":"openrouter","name":"openrouter"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse LLM response and format for API/UI\nconst response = $input.first().json;\nconst normalizedData = $('Normalize Data').first().json;\n\ntry {\n  const content = response.choices[0].message.content;\n  const parsed = JSON.parse(content);\n  const items = parsed.analyzed || parsed.items || [];\n  \n  // Filter for viral_score >= 6 and adaptable = true\n  const filtered = items.filter(item => \n    item.viral_score >= 6 && item.adaptable !== false\n  );\n  \n  return [{\n    json: {\n      success: true,\n      niche: normalizedData.niche,\n      scrapedAt: normalizedData.scrapedAt,\n      totalScraped: normalizedData.totalResults,\n      analyzedCount: filtered.length,\n      trends: filtered\n    }\n  }];\n} catch (error) {\n  return [{\n    json: {\n      success: false,\n      error: error.message,\n      niche: normalizedData.niche,\n      scrapedAt: normalizedData.scrapedAt,\n      totalScraped: normalizedData.totalResults,\n      analyzedCount: 0,\n      trends: []\n    }\n  }];\n}"},"id":"scrape-format-response","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,160]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Process trends, save to DB, and guarantee response\nconst data = $input.first().json;\nconst savedItems = [];\nlet savedCount = 0;\n\n// 1. Handle Empty/Error Case\nif (!data.success || !data.trends || data.trends.length === 0) {\n  return [{\n    json: {\n      success: true, // Return success so UI doesn't crash\n      niche: data.niche,\n      scrapedAt: data.scrapedAt,\n      totalScraped: data.totalScraped || 0,\n      analyzedCount: 0,\n      savedCount: 0,\n      message: 'No suitable trends found to save',\n      trends: []\n    }\n  }];\n}\n\n// 2. Process & Save Each Trend\nfor (const trend of data.trends) {\n  try {\n    // Infer platform\n    let platform = trend.platform;\n    const url = trend.url || '';\n    if (!platform || platform === 'unknown') {\n      if (url.includes('tiktok.com')) platform = 'tiktok';\n      else if (url.includes('instagram.com')) platform = 'instagram';\n      else if (url.includes('youtube.com') || url.includes('youtu.be')) platform = 'youtube';\n    }\n    \n    // Construct Payload\n    const payload = {\n      source_url: url,\n      source_platform: (platform ? platform.toLowerCase() : 'unknown'),\n      original_text: trend.title || '',\n      pillar: trend.pillar || 'educational_tips',\n      viral_score: trend.viral_score || 7,\n      suggested_hook: trend.suggested_hook || '',\n      why_viral: trend.why_viral || '',\n      status: 'pending'\n    };\n\n    // Send to Backend\n    // Using this.helpers.request (n8n built-in)\n    const response = await this.helpers.request({\n      method: 'POST',\n      url: 'http://backend:8000/api/content-ideas',\n      body: payload,\n      json: true\n    });\n    \n    if (response && response.id) {\n        savedItems.push(response);\n        savedCount++;\n    }\n  } catch (err) {\n    console.log(`Failed to save trend: ${err.message}`);\n    // Continue to next item, don't stop workflow\n  }\n}\n\n// 3. Return Summary Response\nreturn [{\n  json: {\n    success: true,\n    niche: data.niche,\n    scrapedAt: data.scrapedAt,\n    totalScraped: data.totalScraped,\n    analyzedCount: data.analyzedCount,\n    savedCount: savedCount,\n    message: `Saved ${savedCount} content ideas to database`,\n    trends: savedItems\n  }\n}];"},"id":"scrape-process-save","name":"Process & Save Trends","type":"n8n-nodes-base.code","typeVersion":2,"position":[288,160]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"scrape-respond","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[784,160]},{"parameters":{"content":"## 2. Auto Trigger\nSchedule (15min) + Webhook to start pipeline","height":140,"width":180,"color":4},"id":"note-auto-trigger","name":"Auto Trigger","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[144,-32]},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"id":"schedule-trigger","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[368,-32],"disabled":true},{"parameters":{"httpMethod":"POST","path":"trigger-pipeline","responseMode":"responseNode","options":{}},"id":"webhook-trigger","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[64,400],"webhookId":"eb59ea2b-8f7b-4ac5-a593-5febc10fa1da","onError":"continueRegularOutput"},{"parameters":{"url":"http://backend:8000/api/content-ideas?status=approved&limit=1","options":{}},"id":"get-approved-idea","name":"Get Approved Idea","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[416,480]},{"parameters":{"respondWith":"text","responseBody":"Pipeline Triggered","options":{}},"id":"trigger-respond-immediate","name":"Respond Immediately","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,544]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-specific-id","leftValue":"={{ $json.body?.content_idea_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"if-specific-id","name":"Specific ID?","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,400]},{"parameters":{"url":"=http://backend:8000/api/content-ideas/{{ $json.body.content_idea_id }}","options":{}},"id":"get-specific-idea","name":"Get Specific Idea","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[608,480]},{"parameters":{},"id":"merge-idea-sources","name":"Merge","type":"n8n-nodes-base.merge","typeVersion":3,"position":[496,224]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Normalize and validate content idea\nconst items = $input.all();\nlet idea = null;\n\nfor (const item of items) {\n  const data = item.json;\n  if (Array.isArray(data) && data.length > 0) {\n    idea = data[0];\n    break;\n  } else if (data && data.id) {\n    idea = data;\n    break;\n  }\n}\n\nif (!idea || !idea.id) {\n  return [{ json: { hasContent: false, message: 'No approved content found' } }];\n}\n\nreturn [{\n  json: {\n    hasContent: true,\n    content_idea_id: idea.id,\n    original_text: idea.original_text,\n    pillar: idea.pillar,\n    suggested_hook: idea.suggested_hook,\n    source_platform: idea.source_platform,\n    source_url: idea.source_url\n  }\n}];"},"id":"normalize-idea","name":"Normalize Idea","type":"n8n-nodes-base.code","typeVersion":2,"position":[640,224]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-content","leftValue":"={{ $json.hasContent }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-has-content","name":"Has Content?","type":"n8n-nodes-base.if","typeVersion":2,"position":[992,224]},{"parameters":{},"id":"no-content-end","name":"No Content","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1216,240]},{"parameters":{"content":"## Script Generation\nGrok 4.1 creates viral script","height":140,"width":180,"color":5},"id":"note-script-gen","name":"Script Gen","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,528]},{"parameters":{"method":"PATCH","url":"=http://backend:8000/api/content-ideas/{{ $json.content_idea_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"script_generating\"\n}","options":{}},"id":"update-status-processing","name":"Update Status","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[64,688]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"HTTP-Referer","value":"http://100.83.153.43:5678"},{"name":"X-Title","value":"n8n-video-pipeline"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  model: \"x-ai/grok-4.1-fast\",\n  messages: [\n    {\n      role: \"system\",\n      content: ($('Fetch Settings').first().json.llm && $('Fetch Settings').first().json.llm.character_persona ? $('Fetch Settings').first().json.llm.character_persona : 'You are Beth Anderson, an amazing realtor in Coeur d\\'Alene, Idaho and Liberty Lake, Washington. You are reviewing a viral video to provide value to your clients.') + \"\\n\\nUsing the provided content idea, write a script where you critique or praise the video, showing what is right or wrong, and demonstrating your expertise.\\nThe video will be playing behind you. You are the expert.\\n\\nStructure:\\n1. Hook: Catchy opening related to the topic.\\n2. Body: Your expert analysis.\\n3. Call to Action: How you can help them.\\n\\nGUIDELINES:\\n- Start with a hook that stops scrollers in the first 3 seconds\\n- Use conversational, energetic tone\\n- Include ONE clear call-to-action\\n- Add natural pauses marked with [PAUSE]\\n- Mark emphasis with *asterisks*\\n- Keep sentences short and punchy\\n- Total length: 150-250 words\\n\\nPILLAR TONES:\\n- market_intelligence: Data-driven, authoritative, slightly urgent\\n- educational_tips: Helpful, encouraging, clear steps\\n- lifestyle_local: Warm, community-focused, storytelling\\n- brand_humanization: Personal, relatable, authentic\\n\\nRETURN JSON:\\n{\\n  \\\"hook\\\": \\\"First 3 seconds text\\\",\\n  \\\"script\\\": \\\"Full script with [PAUSE] and *emphasis* markers\\\",\\n  \\\"cta\\\": \\\"Call to action text\\\",\\n  \\\"estimated_duration_seconds\\\": 45,\\n  \\\"suggested_broll\\\": [\\\"scene description 1\\\", \\\"scene description 2\\\", \\\"scene description 3\\\"]\\n}\"\n    },\n    {\n      role: \"user\",\n      content: \"Create a script based on this content idea:\\n\\nPillar: \" + $('Normalize Idea').first().json.pillar + \"\\nSuggested Hook: \" + $('Normalize Idea').first().json.suggested_hook + \"\\nOriginal Content: \" + ($('Normalize Idea').first().json.original_text ? $('Normalize Idea').first().json.original_text.substring(0, 1500) : '') + \"\\nSource: \" + $('Normalize Idea').first().json.source_platform\n    }\n  ],\n  temperature: 0.7,\n  max_tokens: 2000,\n  response_format: { type: \"json_object\" }\n} }}","options":{"timeout":60000}},"id":"generate-script-llm","name":"Generate Script (Grok)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[288,688],"credentials":{"httpHeaderAuth":{"id":"openrouter","name":"openrouter"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Parse script from LLM response\nconst items = $input.all();\nif (!items || items.length === 0) {\n  throw new Error('No input data received');\n}\n\nconst response = items[0].json;\nlet prevData = {};\n\ntry {\n  prevData = $('Normalize Idea').first().json;\n} catch (e) {\n  // Fallback if node reference fails\n}\n\ntry {\n  const content = response.choices[0].message.content;\n  \n  // Try to parse as JSON, handle markdown code blocks\n  let cleanContent = content;\n  if (content.includes('```json')) {\n    cleanContent = content.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (content.includes('```')) {\n    cleanContent = content.replace(/```\\n?/g, '').trim();\n  }\n  \n  const scriptData = JSON.parse(cleanContent);\n  \n  return [{\n    json: {\n      content_idea_id: prevData.content_idea_id || scriptData.content_idea_id,\n      hook: scriptData.hook || '',\n      body: scriptData.script || scriptData.body || '',\n      cta: scriptData.cta || '',\n      full_script: `${scriptData.hook || ''} ${scriptData.script || scriptData.body || ''} ${scriptData.cta || ''}`.trim(),\n      duration_estimate: scriptData.estimated_duration_seconds || scriptData.duration_estimate || 45,\n      suggested_broll: scriptData.suggested_broll || [],\n      pillar: prevData.pillar || scriptData.pillar || 'general',\n      source_url: prevData.source_url || ''\n    }\n  }];\n} catch (error) {\n  // Return error info for debugging\n  return [{\n    json: {\n      error: true,\n      errorMessage: error.message,\n      rawContent: response.choices?.[0]?.message?.content?.substring(0, 500) || 'No content',\n      content_idea_id: prevData.content_idea_id\n    }\n  }];\n}"},"id":"parse-script","name":"Parse Script","type":"n8n-nodes-base.code","typeVersion":2,"position":[512,688]},{"parameters":{"method":"POST","url":"http://backend:8000/api/scripts","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"content_idea_id\": {{ $json.content_idea_id }},\n  \"hook\": {{ JSON.stringify($json.hook) }},\n  \"body\": {{ JSON.stringify($json.script || '') }},\n  \"cta\": {{ JSON.stringify($json.cta) }},\n  \"full_script\": {{ JSON.stringify($json.hook + ' ' + $json.script + ' ' + $json.cta) }},\n  \"duration_estimate\": {{ $json.estimated_duration || 45 }},\n  \"status\": \"script_ready\"\n}","options":{}},"id":"save-script","name":"Save Script","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,688]},{"parameters":{"method":"POST","url":"http://backend:8000/api/assets","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"script_id\": {{ $json.id }},\n  \"status\": \"pending\"\n}","options":{}},"id":"create-asset-record","name":"Create Asset Record","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[944,688]},{"parameters":{"content":"## 4. GET VIDEO\nDownload source video from TikTok/Instagram/YouTube using yt-dlp","height":140,"width":180,"color":6},"id":"note-get-video","name":"Get Video","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,912]},{"parameters":{"content":"## Create Voice\nElevenLabs TTS + duration check","height":140,"width":180,"color":7},"id":"note-create-voice","name":"Create Voice","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,1168]},{"parameters":{"url":"http://backend:8000/api/config/character","options":{}},"id":"get-character-config","name":"Get Character Config","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[64,1184]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Get character configuration from the previous node (HTTP Request)\nconst items = $input.all();\nconst charConfig = items[0]?.json || {};\n\n// Get script and asset data from upstream - use try/catch for safety\nlet scriptData = {}, assetData = {}, parseData = {}, sourceVideoPath = '';\n\ntry {\n  scriptData = $('Save Script').first().json;\n} catch (e) { console.log('Save Script not found'); }\n\ntry {\n  assetData = $('Create Asset Record').first().json;\n} catch (e) { console.log('Create Asset Record not found'); }\n\ntry {\n  parseData = $('Parse Script').first().json;\n} catch (e) { console.log('Parse Script not found'); }\n\ntry {\n  sourceVideoPath = $('Verify Download').first().json.saved_path || '';\n} catch (e) { console.log('Verify Download not found'); }\n\n// Clean script for TTS (remove pauses, scene directions, extra spaces)\nlet text = parseData.body || parseData.script || '';\ntext = text.replace(/\\[PAUSE\\]/gi, '...');\ntext = text.replace(/\\*(.*?)\\*/g, '$1');\ntext = text.replace(/\\s+/g, ' ').trim();\n\nif (parseData.cta) {\n  text = text + ' ... ' + parseData.cta;\n}\n\n// Robust Voice ID Selection\nlet voiceId = charConfig.voice_id;\nif (!voiceId || typeof voiceId !== 'string' || voiceId.trim().length < 5) {\n  console.log(`Invalid or missing voice_id '${voiceId}', falling back to Rachel.`);\n  voiceId = '21m00Tcm4TlvDq8ikWAM'; // Rachel\n} else {\n  voiceId = voiceId.trim();\n}\n\n// Avatar type mapping:\n// - video_avatar: HeyGen premade video avatar\n// - talking_photo: HeyGen existing talking photo\n// - custom_photo: User-uploaded photo\nconst avatarType = charConfig.avatar_type || 'video_avatar';\n\nreturn [{\n  json: {\n    asset_id: assetData.id || null,\n    script_id: scriptData.id || parseData.script_id || null,\n    content_idea_id: parseData.content_idea_id || null,\n    text_for_tts: text,\n    voice_id: voiceId,\n    avatar_id: charConfig.avatar_id || 'Kristin_pubblic_3_20240108',\n    avatar_type: avatarType,\n    config_image_url: charConfig.image_url || '',\n    broll_paths: sourceVideoPath ? [sourceVideoPath] : []\n  }\n}];"},"id":"prepare-tts-text","name":"Prepare TTS Text","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,1184]},{"parameters":{"method":"POST","url":"=https://api.elevenlabs.io/v1/text-to-speech/{{ $json.voice_id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"audio/mpeg"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { \"text\": $json.text_for_tts, \"model_id\": \"eleven_multilingual_v2\", \"voice_settings\": { \"stability\": 0.5, \"similarity_boost\": 0.75, \"style\": 0.5, \"use_speaker_boost\": true } } }}","options":{"response":{},"timeout":120000}},"id":"generate-voice","name":"Generate Voice (ElevenLabs)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[656,1248],"credentials":{"httpHeaderAuth":{"id":"elevenlabs","name":"elevenlabs"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\nconst items = $input.all();\nconst sourceData = items[0]?.json || {};\n\ntry {\n  const scriptId = sourceData.script_id;\n  const filePath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n  const exists = fs.existsSync(filePath);\n  \n  // MERGE source data so voice_id/text_for_tts persist to the Generator\n  return [{ \n    json: { \n      ...sourceData,\n      exists, \n      filePath, \n      script_id: scriptId,\n      voice_id: sourceData.voice_id \n    } \n  }];\n} catch (e) {\n  return [{ json: { ...sourceData, exists: false, error: e.message } }];\n}"},"id":"check-voice-exists","name":"Check Voice Exists","type":"n8n-nodes-base.code","typeVersion":2,"position":[368,1184]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"file-exists","leftValue":"={{ $json.exists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-voice-exists","name":"Voice Exists?","type":"n8n-nodes-base.if","typeVersion":2,"position":[512,1184]},{"parameters":{"fileName":"=/home/node/.n8n-files/assets/audio/{{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3","options":{}},"id":"save-voice-file","name":"Save Voice","type":"n8n-nodes-base.writeBinaryFile","typeVersion":1,"position":[800,1248]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const { execSync } = require('child_process');\nconst items = $input.all();\nconst inputData = items[0]?.json || {};\n\n// Get script_id from input or from Prepare TTS Text\nlet scriptId = inputData.script_id;\nif (!scriptId) {\n  try {\n    scriptId = $('Prepare TTS Text').first().json.script_id;\n  } catch (e) {\n    scriptId = 22; // fallback\n  }\n}\n\nconst audioPath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n\ntry {\n  const result = execSync(`ffprobe -v quiet -show_entries format=duration -of csv=p=0 \"${audioPath}\"`, { encoding: 'utf-8' });\n  const duration = parseFloat(result.trim()) || 45;\n  return [{ json: { ...inputData, duration, voiceover_duration: duration, success: true } }];\n} catch (error) {\n  return [{ json: { ...inputData, duration: 45, voiceover_duration: 45, success: false, error: error.message } }];\n}"},"id":"get-voice-duration","name":"Get Duration","type":"n8n-nodes-base.code","typeVersion":2,"position":[944,1168]},{"parameters":{"method":"PATCH","url":"=http://backend:8000/api/assets/{{ $('Prepare TTS Text').first().json.asset_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"voiceover_path\": \"/home/node/.n8n-files/assets/audio/{{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3\",\n  \"status\": \"voice_ready\"\n}","options":{}},"id":"update-asset-voice","name":"Update Asset Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1088,1168]},{"parameters":{"filePath":"=/home/node/.n8n-files/assets/audio/{{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3"},"id":"read-audio-file","name":"Read Audio File","type":"n8n-nodes-base.readBinaryFile","typeVersion":1,"position":[1296,1168]},{"parameters":{"content":"## Create Avatar\nHeyGen lip-sync video generation","height":140,"width":180,"color":3},"id":"note-create-avatar","name":"Create Avatar","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,1728]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Parse inputs from upstream nodes\nconst uploadResult = $('Upload HeyGen Audio').first().json;\nconst durationResult = $('Get Duration').first().json;\nconst ttsData = $('Prepare TTS Text').first().json;\n\n// Get greenscreen settings from Fetch Settings\nconst fetchedSettings = $('Fetch Settings').first().json;\nconst videoSettings = fetchedSettings?.settings?.video || {};\nconst greenscreenEnabled = videoSettings.greenscreen_enabled ?? true;\nconst greenscreenColor = videoSettings.greenscreen_color || '#00FF00';\n\n// Check for Dynamic Photo Upload (only used for custom_photo type)\nlet dynamicPhotoId = null;\ntry {\n  const photoUpload = $('Upload Talking Photo').first();\n  if (photoUpload && photoUpload.json && photoUpload.json.data) {\n    dynamicPhotoId = photoUpload.json.data.talking_photo_id || photoUpload.json.data.id;\n  }\n} catch(e) {\n  // No upload - that's fine for non-custom_photo types\n}\n\nlet duration = 45;\ntry {\n  duration = parseFloat(durationResult.stdout?.trim()) || 45;\n} catch (e) {}\n\n// Avatar Logic based on avatar_type from Character config\nlet avatarId = ttsData.avatar_id;\nlet avatarType = ttsData.avatar_type || 'video_avatar';\n\n// Handle avatar types:\n// - video_avatar: Use HeyGen's premade video avatar (avatar_type = 'avatar')\n// - talking_photo: Use HeyGen's existing talking photo (avatar_type = 'talking_photo')\n// - custom_photo: Use dynamically uploaded photo (avatar_type = 'talking_photo')\n\nlet heygenAvatarType = 'avatar'; // Default for HeyGen API\n\nif (avatarType === 'custom_photo') {\n  // Custom uploaded photo - use the dynamic upload ID\n  if (dynamicPhotoId) {\n    avatarId = dynamicPhotoId;\n    heygenAvatarType = 'talking_photo';\n  } else {\n    // Fallback to default video avatar if upload failed\n    console.log('Missing dynamic photo upload, falling back to default avatar');\n    avatarId = 'Anna_public_3_20240108';\n    heygenAvatarType = 'avatar';\n  }\n} else if (avatarType === 'talking_photo') {\n  // Use existing talking photo from HeyGen's library\n  heygenAvatarType = 'talking_photo';\n} else {\n  // video_avatar - use premade HeyGen avatar\n  heygenAvatarType = 'avatar';\n}\n\nreturn [{\n  json: {\n    asset_id: ttsData.asset_id,\n    script_id: ttsData.script_id,\n    content_idea_id: ttsData.content_idea_id,\n    voice_path: `/home/node/.n8n-files/assets/audio/${ttsData.script_id}_voice.mp3`,\n    duration_seconds: Math.round(duration * 10) / 10,\n    broll_paths: ttsData.broll_paths,\n    avatar_id: avatarId,\n    avatar_type: heygenAvatarType,\n    audio_asset_id: uploadResult.data?.id || '',\n    greenscreen_enabled: greenscreenEnabled,\n    greenscreen_color: greenscreenColor\n  }\n}];"},"id":"prepare-heygen-data","name":"Prepare HeyGen Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,1760]},{"parameters":{"method":"POST","url":"https://api.heygen.com/v2/video/generate","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{\n{\n  \"video_inputs\": [\n    {\n      \"character\": $json.avatar_type === 'talking_photo'\n        ? {\n            \"type\": \"talking_photo\",\n            \"talking_photo_id\": $json.avatar_id\n          }\n        : {\n            \"type\": \"avatar\",\n            \"avatar_id\": $json.avatar_id,\n            \"avatar_style\": \"normal\"\n          },\n      \"voice\": {\n        \"type\": \"audio\",\n        \"audio_asset_id\": $json.audio_asset_id\n      },\n      \"background\": $json.greenscreen_enabled\n        ? {\n            \"type\": \"color\",\n            \"value\": $json.greenscreen_color || \"#00FF00\"\n          }\n        : {\n            \"type\": \"color\",\n            \"value\": \"#000000\"\n          }\n    }\n  ],\n  \"dimension\": {\n    \"width\": 720,\n    \"height\": 1280\n  },\n  \"aspect_ratio\": \"9:16\"\n}\n}}","options":{"timeout":60000}},"id":"create-heygen-video","name":"Create HeyGen Video","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[576,1776],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\ntry {\n  const sourceNode = $('Prepare HeyGen Data').first();\n  const sourceData = sourceNode.json;\n  const scriptId = sourceData.script_id;\n  const filePath = `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\n  const exists = fs.existsSync(filePath);\n  \n  // MERGE source data so audio_asset_id / avatar_id persist to the Generator\n  return [{ \n      json: { \n          ...sourceData,\n          exists, \n          filePath, \n          script_id: scriptId\n      } \n  }];\n} catch (e) {\n  return [{ json: { exists: false, error: e.message } }];\n}"},"id":"check-video-exists","name":"Check Video Exists","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,1760]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"file-exists","leftValue":"={{ $json.exists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-video-exists","name":"Video Exists?","type":"n8n-nodes-base.if","typeVersion":2,"position":[384,1760]},{"parameters":{"jsCode":"// Extract HeyGen video ID, save to database, and initialize retry counter\nconst response = $input.first().json;\nconst prevData = $('Prepare HeyGen Data').first().json;\n\nif (!response.data?.video_id) {\n  throw new Error(`HeyGen error: ${JSON.stringify(response)}`);\n}\n\nconst heygenVideoId = response.data.video_id;\nconst assetId = prevData.asset_id;\n\n// Save heygen_video_id to database immediately\ntry {\n  const saveResponse = await fetch(`http://backend:8000/api/assets/${assetId}`, {\n    method: 'PATCH',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ \n      heygen_video_id: heygenVideoId,\n      status: 'avatar_generating'\n    })\n  });\n  \n  if (!saveResponse.ok) {\n    console.log(`Warning: Failed to save heygen_video_id: ${saveResponse.status}`);\n  } else {\n    console.log(`Saved heygen_video_id ${heygenVideoId} to asset ${assetId}`);\n  }\n} catch (e) {\n  console.log(`Warning: Error saving heygen_video_id: ${e.message}`);\n}\n\nreturn [{\n  json: {\n    ...prevData,\n    heygen_video_id: heygenVideoId,\n    retry_count: 0,\n    max_retries: 20\n  }\n}];"},"id":"extract-heygen-id","name":"Extract Video ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[384,1632]},{"parameters":{"amount":30},"id":"wait-heygen","name":"Wait 30s","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[576,1632],"webhookId":"heygen-wait"},{"parameters":{"url":"=https://api.heygen.com/v1/video_status.get?video_id={{ $json.heygen_video_id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{}},"id":"check-heygen-status","name":"Check Status","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[800,1776],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Increment retry counter and check max\nconst inputData = $input.first().json;\nconst retryCount = (inputData.retry_count || 0) + 1;\nconst maxRetries = inputData.max_retries || 20;\n\nif (retryCount > maxRetries) {\n  throw new Error(`HeyGen timeout: Video ${inputData.heygen_video_id} did not complete after ${maxRetries} retries (~${maxRetries} minutes). Last status: ${inputData.heygen_status}`);\n}\n\nreturn [{\n  json: {\n    ...inputData,\n    retry_count: retryCount\n  }\n}];"},"id":"increment-retry","name":"Increment Retry","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,1968]},{"parameters":{"amount":60},"id":"wait-retry","name":"Wait & Retry","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1248,1968],"webhookId":"heygen-retry"},{"parameters":{"url":"={{ $('Check Status').first().json.data.video_url }}","options":{"response":{"response":{"responseFormat":"file"}},"timeout":180000}},"id":"download-avatar","name":"Download Avatar","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1088,1776]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const fs = require('fs');\nconst item = $input.item;\ntry {\n  const scriptId = $('Extract Video ID').first().json.script_id;\n  const fileName = `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\n  \n  if (item.binary && item.binary.data) {\n    fs.writeFileSync(fileName, Buffer.from(item.binary.data.data, 'base64'));\n    item.json.saved_path = fileName;\n  }\n} catch (e) {\n  console.log('Error writing avatar file: ' + e.message);\n  throw e;\n}\nreturn item;"},"id":"save-avatar-file","name":"Save Avatar","type":"n8n-nodes-base.code","typeVersion":2,"position":[1232,1776]},{"parameters":{"content":"## Combine Videos + Music\nFFmpeg chromakey compositing","height":140,"width":180,"color":2},"id":"note-combine","name":"Combine Vids","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,2112]},{"parameters":{"jsCode":"const fs = require('fs');\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input data', success: false } }];\n}\n\nconst sourceData = items[0].json;\nconst scriptId = sourceData.script_id;\n\n// Get settings from input\nconst settings = sourceData.settings || {\n  audio: { original_volume: 0.7, avatar_volume: 1.0, music_volume: 0.3, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5, music_autoduck: true },\n  video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow' }\n};\n\nconst audioSettings = settings.audio || {};\nconst videoSettings = settings.video || {};\n\n// Audio settings\nconst origVol = audioSettings.original_volume ?? 0.7;\nconst avatarVol = audioSettings.avatar_volume ?? 1.0;\nconst musicVol = audioSettings.music_volume ?? 0.3;\nconst duckEnabled = audioSettings.ducking_enabled ?? true;\nconst avatarDelay = audioSettings.avatar_delay_seconds ?? 3;\nconst duckTo = audioSettings.duck_to_percent ?? 0.5;\nconst musicAutoduck = audioSettings.music_autoduck ?? true;\n\n// Video settings\nconst outputWidth = videoSettings.output_width || 1080;\nconst outputHeight = videoSettings.output_height || 1920;\nconst crf = videoSettings.crf || 18;\nconst preset = videoSettings.preset || 'slow';\n\n// File paths\nconst avatarPath = sourceData.avatar_path || `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\nconst sourcePath = sourceData.source_video_path || `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\nconst voicePath = sourceData.voice_path || `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\nconst outputPath = `/home/node/.n8n-files/assets/output/${scriptId}_combined.mp4`;\n\n// Check for active music file\nconst musicDir = '/home/node/.n8n-files/assets/music';\nlet musicPath = null;\ntry {\n  if (fs.existsSync(musicDir)) {\n    const files = fs.readdirSync(musicDir).filter(f => f.endsWith('.mp3') || f.endsWith('.wav'));\n    const activeFile = files.find(f => f.startsWith('active_'));\n    if (activeFile) {\n      musicPath = `${musicDir}/${activeFile}`;\n    } else if (files.length > 0) {\n      musicPath = `${musicDir}/${files[0]}`;\n    }\n  }\n} catch (e) {\n  console.log('No music directory or files found');\n}\n\nconst avatarExists = fs.existsSync(avatarPath);\nconst sourceExists = fs.existsSync(sourcePath);\nconst voiceExists = fs.existsSync(voicePath);\nconst musicExists = musicPath && fs.existsSync(musicPath);\n\nif (!avatarExists) {\n  return [{ json: { error: `Avatar not found: ${avatarPath}`, success: false } }];\n}\n\n// Build inputs\nlet inputs = '';\nlet sourceIndex = -1, avatarIndex = -1, voiceIndex = -1, musicIndex = -1;\nlet inputCount = 0;\n\nif (sourceExists) {\n  inputs += `-stream_loop -1 -i \"${sourcePath}\"`;\n  sourceIndex = inputCount++;\n}\n\ninputs += ` -i \"${avatarPath}\"`;\navatarIndex = inputCount++;\n\nif (voiceExists) {\n  inputs += ` -i \"${voicePath}\"`;\n  voiceIndex = inputCount++;\n}\n\nif (musicExists && musicVol > 0) {\n  inputs += ` -stream_loop -1 -i \"${musicPath}\"`;\n  musicIndex = inputCount++;\n}\n\n// Build filter complex\nlet fc = '';\n\n// VIDEO: Scale and overlay avatar at BOTTOM-LEFT\nif (sourceExists) {\n  fc += `[${sourceIndex}:v]scale=${outputWidth}:${outputHeight}:force_original_aspect_ratio=increase,crop=${outputWidth}:${outputHeight},setsar=1[bg];`;\n  fc += `[${avatarIndex}:v]scale=${outputWidth}:-1,chromakey=0x00FF00:0.1:0.2[avatar_keyed];`;\n  fc += `[bg][avatar_keyed]overlay=0:H-h:shortest=1[outv];`;\n} else {\n  fc += `[${avatarIndex}:v]scale=${outputWidth}:-1,chromakey=0x00FF00:0.1:0.2[avatar_keyed];`;\n  fc += `color=c=#1a1a2e:s=${outputWidth}x${outputHeight}:d=120[bg];`;\n  fc += `[bg][avatar_keyed]overlay=0:H-h:shortest=1[outv];`;\n}\n\n// AUDIO: Mix original, voice, and music\nconst delayMs = Math.round(avatarDelay * 1000);\n\nif (musicExists && musicVol > 0 && voiceExists) {\n  // Voice track (delayed) - split into two: one for sidechain key, one for mix\n  fc += `[${voiceIndex}:a]adelay=${delayMs}|${delayMs},volume=${avatarVol},asplit=2[voice][voice_key];`;\n  \n  // Music track - with or without sidechaincompress based on music_autoduck setting\n  if (musicAutoduck) {\n    // Use sidechaincompress to auto-duck music when voice plays\n    fc += `[${musicIndex}:a]volume=${musicVol}[music_vol];`;\n    fc += `[music_vol][voice_key]sidechaincompress=threshold=0.02:ratio=4:attack=50:release=500[music_processed];`;\n  } else {\n    // No auto-ducking, just constant volume\n    fc += `[${musicIndex}:a]volume=${musicVol}[music_processed];`;\n    fc += `[voice_key]anullsink;`;  // discard the unused split\n  }\n  \n  if (sourceExists && duckEnabled) {\n    fc += `[${sourceIndex}:a]volume=${origVol}:enable='lt(t,${avatarDelay})',volume=${origVol * duckTo}:enable='gte(t,${avatarDelay})'[orig];`;\n    fc += `[orig][voice][music_processed]amix=inputs=3:duration=shortest:dropout_transition=0,volume=2.5[outa]`;\n  } else if (sourceExists) {\n    fc += `[${sourceIndex}:a]volume=${origVol}[orig];`;\n    fc += `[orig][voice][music_processed]amix=inputs=3:duration=shortest:dropout_transition=0,volume=2.5[outa]`;\n  } else {\n    fc += `[voice][music_processed]amix=inputs=2:duration=shortest:dropout_transition=0,volume=2[outa]`;\n  }\n} else if (voiceExists) {\n  // No music, just original + voice\n  fc += `[${voiceIndex}:a]adelay=${delayMs}|${delayMs},volume=${avatarVol}[voice];`;\n  if (sourceExists && duckEnabled) {\n    fc += `[${sourceIndex}:a]volume=${origVol}:enable='lt(t,${avatarDelay})',volume=${origVol * duckTo}:enable='gte(t,${avatarDelay})'[orig];`;\n    fc += `[orig][voice]amix=inputs=2:duration=longest:dropout_transition=0,volume=2[outa]`;\n  } else if (sourceExists) {\n    fc += `[${sourceIndex}:a]volume=${origVol}[orig];`;\n    fc += `[orig][voice]amix=inputs=2:duration=longest:dropout_transition=0,volume=2[outa]`;\n  } else {\n    fc += `[voice]acopy[outa]`;\n  }\n} else {\n  fc += `[${avatarIndex}:a]aformat=channel_layouts=stereo[outa]`;\n}\n\nconst ffmpegCmd = `ffmpeg -y ${inputs} -filter_complex \"${fc}\" ` +\n  `-map \"[outv]\" -map \"[outa]\" ` +\n  `-c:v libx264 -preset ${preset} -crf ${crf} ` +\n  `-s ${outputWidth}x${outputHeight} ` +\n  `-c:a aac -b:a 192k -ar 48000 ` +\n  `-movflags +faststart -pix_fmt yuv420p ` +\n  `\"${outputPath}\"`;\n\nreturn [{\n  json: {\n    asset_id: sourceData.asset_id,\n    script_id: scriptId,\n    content_idea_id: sourceData.content_idea_id,\n    ffmpeg_command: ffmpegCmd,\n    output_path: outputPath,\n    avatar_path: avatarPath,\n    source_video_path: sourcePath,\n    voice_path: voicePath,\n    music_path: musicPath,\n    music_enabled: musicExists && musicVol > 0,\n    music_autoduck: musicAutoduck,\n    settings: settings\n  }\n}];"},"id":"build-ffmpeg-cmd","name":"Build FFmpeg Command","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,2128]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const { execSync } = require('child_process');\nconst fs = require('fs');\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\nconst ffmpegCmd = inputData.ffmpeg_command;\nconst outputPath = inputData.output_path;\nconst avatarPath = inputData.avatar_path;\n\n// Check if input files exist first\nconst avatarExists = fs.existsSync(avatarPath);\nif (!avatarExists) {\n  return [{ json: { \n    ...inputData,\n    stderr: `Avatar file not found: ${avatarPath}`,\n    exitCode: 1,\n    success: false,\n    avatar_exists: false\n  }}];\n}\n\n// Ensure output directory exists\nconst outputDir = outputPath.substring(0, outputPath.lastIndexOf('/'));\nif (!fs.existsSync(outputDir)) {\n  fs.mkdirSync(outputDir, { recursive: true });\n}\n\ntry {\n  // Execute FFmpeg with stderr capture\n  const result = execSync(ffmpegCmd, { \n    encoding: 'utf-8', \n    timeout: 300000,\n    maxBuffer: 50 * 1024 * 1024\n  });\n  \n  const fileExists = fs.existsSync(outputPath);\n  const stats = fileExists ? fs.statSync(outputPath) : null;\n  \n  return [{ json: { \n    ...inputData,\n    stdout: result || '', \n    exitCode: 0, \n    success: fileExists && stats && stats.size > 1000,\n    file_size: stats ? stats.size : 0\n  }}];\n} catch (error) {\n  const fileExists = fs.existsSync(outputPath);\n  const stats = fileExists ? fs.statSync(outputPath) : null;\n  \n  if (fileExists && stats && stats.size > 1000) {\n    return [{ json: { \n      ...inputData,\n      stderr: error.stderr || error.message || '', \n      exitCode: 0, \n      success: true,\n      file_size: stats.size\n    }}];\n  }\n  \n  return [{ json: { \n    ...inputData,\n    stdout: error.stdout || '', \n    stderr: `FFmpeg compose failed: ${error.stderr || error.message || 'Unknown error'}`, \n    exitCode: error.status || 1, \n    success: false \n  }}];\n}"},"id":"run-ffmpeg-combine","name":"Run FFmpeg","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,2128]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"ffmpeg-success","leftValue":"={{ $json.exitCode }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-ffmpeg-success","name":"Success?","type":"n8n-nodes-base.if","typeVersion":2,"position":[368,2128]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input to handle', handled: true } }];\n}\n\nconst inputData = items[0].json;\n\n// Log error and return structured error data\nreturn [{\n  json: {\n    ...inputData,\n    error_handled: true,\n    error_message: inputData.stderr || inputData.error || 'Unknown error'\n  }\n}];"},"id":"handle-ffmpeg-error","name":"Handle Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[544,2144]},{"parameters":{"content":"## Caption\nGenerate SRT + burn captions with FFmpeg","height":140,"width":180},"id":"note-caption","name":"Caption","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,2448]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Prepare data for Whisper transcription\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\nconst inputData = items[0].json;\n\nreturn [{\n  json: {\n    asset_id: inputData.asset_id,\n    script_id: inputData.script_id,\n    content_idea_id: inputData.content_idea_id,\n    combined_video_path: inputData.output_path,\n    audio_path: `/home/node/.n8n-files/assets/audio/${inputData.script_id}_voice.mp3`\n  }\n}];"},"id":"prepare-whisper","name":"Prepare Whisper","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Read audio file and return as binary for Whisper\nconst fs = require('fs');\nconst path = require('path');\n\nconst inputData = $input.first().json;\nconst audioPath = inputData.audio_path;\nconst scriptId = inputData.script_id;\nconst fileName = `${scriptId}_voice.mp3`;\n\n// Read the file as binary\nconst fileBuffer = fs.readFileSync(audioPath);\nconst base64Data = fileBuffer.toString('base64');\n\nreturn [{\n  json: {\n    ...inputData,\n    filePath: audioPath,\n    fileName: fileName\n  },\n  binary: {\n    data: {\n      data: base64Data,\n      mimeType: 'audio/mpeg',\n      fileName: fileName,\n      fileExtension: 'mp3'\n    }\n  }\n}];"},"id":"read-audio-for-whisper","name":"Read Audio for Whisper","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,2480]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/audio/transcriptions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"model","value":"whisper-1"},{"name":"response_format","value":"srt"},{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{"timeout":120000}},"id":"whisper-transcribe","name":"Whisper Transcribe","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[384,2480],"credentials":{"httpHeaderAuth":{"id":"openai","name":"openai"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Extract SRT content from Whisper response\nconst response = $input.first().json;\nconst prevData = $('Prepare Whisper').first().json;\n\n// Whisper returns SRT as plain text in the 'data' field\nconst srtContent = typeof response === 'string' ? response : (response.data || response.text || JSON.stringify(response));\n\nreturn [{\n  json: {\n    asset_id: prevData.asset_id,\n    script_id: prevData.script_id,\n    content_idea_id: prevData.content_idea_id,\n    combined_video_path: prevData.combined_video_path,\n    srt_content: srtContent\n  }\n}];"},"id":"parse-whisper-response","name":"Parse Whisper Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[544,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Save SRT file\nconst fs = require('fs');\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\nconst scriptId = inputData.script_id;\nconst srtPath = `/home/node/.n8n-files/assets/captions/${scriptId}_captions.srt`;\nconst content = inputData.srt_content || '';\n\n// Ensure directory exists\nconst dir = '/home/node/.n8n-files/assets/captions';\nif (!fs.existsSync(dir)) {\n  fs.mkdirSync(dir, { recursive: true });\n}\n\n// Write the SRT file\nfs.writeFileSync(srtPath, content, 'utf8');\n\nreturn [{\n  json: {\n    ...inputData,\n    srt_path: srtPath\n  }\n}];"},"id":"save-srt","name":"Save SRT","type":"n8n-nodes-base.code","typeVersion":2,"position":[704,2480]},{"parameters":{"jsCode":"// Build FFmpeg caption burn command - TikTok style captions at TOP\n// Now enforces 1080p output and uses proper font sizing\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\nconst scriptId = inputData.script_id;\n\n// Get video settings (passed through from earlier nodes)\nconst settings = inputData.settings || {};\nconst videoSettings = settings.video || {};\nconst outputWidth = videoSettings.output_width || 1080;\nconst outputHeight = videoSettings.output_height || 1920;\nconst crf = videoSettings.crf || 18;\nconst preset = videoSettings.preset || 'slow';\n\n// Use actual paths from input\nconst combinedPath = inputData.combined_video_path || `/home/node/.n8n-files/assets/output/${scriptId}_combined.mp4`;\nconst srtPath = inputData.srt_path;\nconst finalPath = `/home/node/.n8n-files/assets/output/${scriptId}_final.mp4`;\n\n// TikTok-style captions properly sized for 1080x1920:\n// - FontSize=12 is appropriate for 1080p vertical video (was 18 which is too big)\n// - Alignment=8 = top-center\n// - MarginV=80 = padding from top\n// - Bold white text with black outline for readability\nconst subtitleFilter = `subtitles=${srtPath}:force_style='FontName=Arial,FontSize=12,PrimaryColour=&HFFFFFF,OutlineColour=&H000000,BackColour=&H40000000,Outline=2,Shadow=1,Bold=1,Alignment=8,MarginV=80,MarginL=60,MarginR=60'`;\n\n// Enforce output resolution with high quality settings\nconst ffmpegCmd = `ffmpeg -y -i \"${combinedPath}\" ` +\n  `-vf \"${subtitleFilter}\" ` +\n  `-c:v libx264 -preset ${preset} -crf ${crf} ` +\n  `-s ${outputWidth}x${outputHeight} ` +\n  `-c:a copy ` +\n  `-movflags +faststart ` +\n  `-pix_fmt yuv420p ` +\n  `\"${finalPath}\"`;\n\nreturn [{\n  json: {\n    ...inputData,\n    ffmpeg_caption_command: ffmpegCmd,\n    final_path: finalPath,\n    combined_path: combinedPath\n  }\n}];"},"id":"build-caption-cmd","name":"Build Caption Cmd","type":"n8n-nodes-base.code","typeVersion":2,"position":[864,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Burn captions via video-processor /caption endpoint\nconst http = require('http');\n\nconst inputData = $input.first().json;\nconst scriptId = inputData.script_id;\n\n// Translate n8n paths to video-processor paths\nfunction translatePath(n8nPath) {\n  const pathMappings = [\n    { from: '/home/node/.n8n-files/assets/avatar/', to: '/avatar/' },\n    { from: '/home/node/.n8n-files/assets/audio/', to: '/audio/' },\n    { from: '/home/node/.n8n-files/assets/videos/', to: '/downloads/' },\n    { from: '/home/node/.n8n-files/assets/music/', to: '/music/' },\n    { from: '/home/node/.n8n-files/assets/captions/', to: '/captions/' },\n    { from: '/home/node/.n8n-files/assets/output/', to: '/outputs/' },\n    { from: '/home/node/.n8n-files/assets/combined/', to: '/outputs/' }\n  ];\n  for (const mapping of pathMappings) {\n    if (n8nPath && n8nPath.startsWith(mapping.from)) {\n      return n8nPath.replace(mapping.from, mapping.to);\n    }\n  }\n  return n8nPath;\n}\n\nconst captionData = {\n  script_id: String(scriptId),\n  video_path: translatePath(inputData.combined_path || `/home/node/.n8n-files/assets/output/${scriptId}_combined.mp4`),\n  srt_path: translatePath(inputData.srt_path || `/home/node/.n8n-files/assets/captions/${scriptId}_captions.srt`),\n  output_filename: `${scriptId}_final.mp4`,\n  use_gpu: true\n};\n\nfunction httpPost(body) {\n  return new Promise((resolve, reject) => {\n    const postData = JSON.stringify(body);\n    const options = {\n      hostname: 'video-processor',\n      port: 8080,\n      path: '/caption',\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Content-Length': Buffer.byteLength(postData)\n      }\n    };\n    const req = http.request(options, (res) => {\n      let data = '';\n      res.on('data', chunk => data += chunk);\n      res.on('end', () => {\n        try {\n          resolve({ statusCode: res.statusCode, body: JSON.parse(data) });\n        } catch (e) {\n          resolve({ statusCode: res.statusCode, body: data });\n        }\n      });\n    });\n    req.on('error', reject);\n    req.write(postData);\n    req.end();\n  });\n}\n\ntry {\n  const result = await httpPost(captionData);\n  if (result.statusCode === 200) {\n    return [{ json: { \n      ...inputData, \n      final_path: `/home/node/.n8n-files/assets/output/${scriptId}_final.mp4`,\n      success: true,\n      error: ''\n    } }];\n  } else {\n    return [{ json: { ...inputData, error: result.body.detail || 'Caption burn failed', success: false } }];\n  }\n} catch (error) {\n  return [{ json: { ...inputData, error: error.message, success: false } }];\n}"},"id":"run-ffmpeg-caption","name":"Burn Captions","type":"n8n-nodes-base.code","typeVersion":2,"position":[1024,2480]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"caption-success","leftValue":"={{ $json.success }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-caption-success","name":"Caption Success?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1168,2480]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input to handle', handled: true } }];\n}\n\nconst inputData = items[0].json;\n\nreturn [{\n  json: {\n    ...inputData,\n    caption_error_handled: true,\n    error_message: inputData.error || 'Caption burning failed'\n  }\n}];"},"id":"handle-caption-error","name":"Handle Caption Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[1392,2496]},{"parameters":{"content":"## Publish\nBlotato multi-platform publishing","height":140,"width":180,"color":4},"id":"note-publish","name":"Publish","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-192,2816]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\n\nreturn [{\n  json: {\n    asset_id: inputData.asset_id,\n    script_id: inputData.script_id,\n    content_idea_id: inputData.content_idea_id,\n    final_video_path: inputData.final_path,\n    file_size: inputData.file_size\n  }\n}];"},"id":"prepare-publish","name":"Prepare Publish Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,2848]},{"parameters":{"filePath":"={{ $json.final_video_path }}","dataPropertyName":"data"},"id":"read-final-video","name":"Read Final Video","type":"n8n-nodes-base.readBinaryFile","typeVersion":1,"position":[208,2848]},{"parameters":{"jsCode":"// Parse Dropbox shared link response and convert to direct download URL\nconst input = $input.first().json;\n\nlet videoUrl = '';\n\n// Check for share response\nif (input.share_response?.url) {\n  // Convert Dropbox share link to direct download\n  // https://www.dropbox.com/s/xxx/file.mp4?dl=0 -> https://dl.dropboxusercontent.com/s/xxx/file.mp4\n  videoUrl = input.share_response.url\n    .replace('www.dropbox.com', 'dl.dropboxusercontent.com')\n    .replace('?dl=0', '')\n    .replace('?dl=1', '');\n} else if (input.share_response?.error?.['.tag'] === 'shared_link_already_exists') {\n  // Link already exists - get it from the error response\n  const existingUrl = input.share_response.error.shared_link_already_exists?.metadata?.url;\n  if (existingUrl) {\n    videoUrl = existingUrl\n      .replace('www.dropbox.com', 'dl.dropboxusercontent.com')\n      .replace('?dl=0', '')\n      .replace('?dl=1', '');\n  } else {\n    throw new Error(`Shared link exists but URL not found: ${JSON.stringify(input.share_response)}`);\n  }\n} else if (input.share_error) {\n  throw new Error(`Dropbox share error: ${input.share_error}`);\n} else if (input.upload_error) {\n  throw new Error(`Dropbox upload error: ${input.upload_error}`);\n} else {\n  throw new Error(`Unexpected response: ${JSON.stringify(input)}`);\n}\n\nreturn [{\n  json: {\n    asset_id: input.asset_id,\n    script_id: input.script_id,\n    content_idea_id: input.content_idea_id,\n    final_video_path: input.final_video_path,\n    video_url: videoUrl,\n    hosted_url: videoUrl\n  }\n}];"},"id":"format-gcs-url","name":"Parse Upload Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[496,2848]},{"parameters":{"method":"POST","url":"https://backend.blotato.com/v2/posts/create","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"platforms\": {{ JSON.stringify($('Parse Upload Response').first().json.platforms || ['tiktok', 'instagram', 'youtube']) }},\n  \"content\": {\n    \"caption\": {{ JSON.stringify($('Parse Upload Response').first().json.caption || '') }},\n    \"video_url\": \"{{ $input.first().json.url || $('Parse Upload Response').first().json.video_url }}\"\n  },\n  \"schedule\": { \"type\": \"now\" },\n  \"options\": { \"auto_hashtags\": false, \"cross_post\": true }\n}","options":{"timeout":120000}},"id":"publish-blotato","name":"Publish (Blotato)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[640,2848],"credentials":{"httpHeaderAuth":{"id":"blotato","name":"blotato"}},"continueOnFail":true},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input', success: false } }];\n}\n\nconst inputData = items[0].json;\n\n// Get data from upstream nodes\nconst uploadResponse = $('Parse Upload Response').first()?.json || {};\nconst publishData = $('Prepare Publish Data').first()?.json || {};\n\n// Check if Blotato publish failed (continueOnFail returns error info)\nconst hasError = inputData.error || inputData.message?.includes('not found') || inputData.statusCode === 404;\n\n// Common output structure\nconst result = {\n  asset_id: publishData.asset_id || uploadResponse.asset_id,\n  script_id: publishData.script_id || uploadResponse.script_id,\n  content_idea_id: publishData.content_idea_id || uploadResponse.content_idea_id,\n  video_url: uploadResponse.video_url || uploadResponse.hosted_url,\n  publish_success: !hasError,\n  publish_skipped: hasError,\n  publish_error: hasError ? 'Blotato credentials not configured' : null,\n  published_at: new Date().toISOString(),\n  // Platform fields (null when skipped)\n  tiktok_url: null,\n  tiktok_id: null,\n  ig_url: null,\n  ig_id: null,\n  yt_url: null,\n  yt_id: null,\n  linkedin_url: null,\n  linkedin_id: null,\n  x_url: null,\n  x_id: null,\n  facebook_url: null,\n  facebook_id: null,\n  threads_url: null,\n  threads_id: null,\n  pinterest_url: null,\n  pinterest_id: null\n};\n\nreturn [{ json: result }];"},"id":"parse-publish-response","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[784,2848]},{"parameters":{"method":"POST","url":"http://backend:8000/api/published","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"asset_id\": {{ $json.asset_id }},\n  \"tiktok_url\": {{ JSON.stringify($json.tiktok_url) }},\n  \"tiktok_id\": {{ JSON.stringify($json.tiktok_id) }},\n  \"ig_url\": {{ JSON.stringify($json.ig_url) }},\n  \"ig_id\": {{ JSON.stringify($json.ig_id) }},\n  \"yt_url\": {{ JSON.stringify($json.yt_url) }},\n  \"yt_id\": {{ JSON.stringify($json.yt_id) }},\n  \"linkedin_url\": {{ JSON.stringify($json.linkedin_url) }},\n  \"linkedin_id\": {{ JSON.stringify($json.linkedin_id) }},\n  \"x_url\": {{ JSON.stringify($json.x_url) }},\n  \"x_id\": {{ JSON.stringify($json.x_id) }},\n  \"facebook_url\": {{ JSON.stringify($json.facebook_url) }},\n  \"facebook_id\": {{ JSON.stringify($json.facebook_id) }},\n  \"threads_url\": {{ JSON.stringify($json.threads_url) }},\n  \"threads_id\": {{ JSON.stringify($json.threads_id) }},\n  \"pinterest_url\": {{ JSON.stringify($json.pinterest_url) }},\n  \"pinterest_id\": {{ JSON.stringify($json.pinterest_id) }}\n}","options":{}},"id":"save-publish-record","name":"Save Publish Record","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,2848]},{"parameters":{"method":"PATCH","url":"=http://backend:8000/api/content-ideas/{{ $('Parse Response').first().json.content_idea_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"status\": \"published\",\n  \"published_at\": {{ JSON.stringify($('Parse Response').first().json.published_at) }}\n}","options":{}},"id":"update-final-status","name":"Update Status Published","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1072,2848]},{"parameters":{"content":"## File Server\nServe audio/video files to external APIs","height":140,"width":180},"id":"note-file-server","name":"File Server","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1504,48]},{"parameters":{"path":"serve-audio/:script_id","responseMode":"responseNode","options":{}},"id":"webhook-serve-audio","name":"Serve Audio","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[1568,208],"webhookId":"2fc52be9-47ee-43eb-a327-3454606b35fa","onError":"continueRegularOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const fs = require('fs');\nconst scriptId = $input.first().json.params.script_id;\nconst filePath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n\ntry {\n  const buffer = fs.readFileSync(filePath);\n  return [{\n    json: $input.first().json,\n    binary: {\n      data: {\n        data: buffer.toString('base64'),\n        mimeType: 'audio/mpeg',\n        fileName: `${scriptId}_voice.mp3`\n      }\n    }\n  }];\n} catch (error) {\n  throw new Error(`Failed to read audio file: ${filePath}. Error: ${error.message}`);\n}"},"id":"read-audio-code-server","name":"Read Audio","type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,208]},{"parameters":{"respondWith":"binary","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"audio/mpeg"}]}}},"id":"respond-audio","name":"Return Audio","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2000,208]},{"parameters":{"path":"serve-video/:script_id","responseMode":"responseNode","options":{}},"id":"webhook-serve-video","name":"Serve Video","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[1568,384],"webhookId":"33394c8b-a4f9-4606-b522-2856840a5297","onError":"continueRegularOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const fs = require('fs');\nconst scriptId = $input.first().json.params.script_id;\nconst filePath = `/home/node/.n8n-files/assets/output/${scriptId}_final.mp4`;\n\ntry {\n  const buffer = fs.readFileSync(filePath);\n  return [{\n    json: $input.first().json,\n    binary: {\n      data: {\n        data: buffer.toString('base64'),\n        mimeType: 'video/mp4',\n        fileName: `${scriptId}_final.mp4`\n      }\n    }\n  }];\n} catch (error) {\n  throw new Error(`Failed to read video file: ${filePath}. Error: ${error.message}`);\n}"},"id":"read-video-file","name":"Read Video","type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,384]},{"parameters":{"respondWith":"binary","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"video/mp4"}]}}},"id":"respond-video","name":"Return Video","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2000,384]},{"parameters":{"method":"POST","url":"=https://upload.heygen.com/v1/asset?name={{ $('Prepare TTS Text').first().json.script_id }}_voice.mp3","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"binaryData","inputDataFieldName":"data","options":{}},"name":"Upload HeyGen Audio","id":"upload-heygen-audio-http","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1936,624],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"errorMessage":"HeyGen Generation Failed"},"id":"stop-heygen-error","name":"Stop on Failure","type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[1440,1888]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-custom-photo","leftValue":"={{ $('Prepare TTS Text').first().json.avatar_type }}","rightValue":"custom_photo","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-is-photo","name":"Is Talking Photo?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2112,624]},{"parameters":{"url":"={{ $('Prepare TTS Text').first().json.config_image_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"download-char-image","name":"Download Character Image","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2272,1392]},{"parameters":{"method":"POST","url":"https://upload.heygen.com/v1/talking_photo","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"image","parameterType":"formBinaryData","inputDataFieldName":"data"}]},"options":{}},"id":"upload-talking-photo","name":"Upload Talking Photo","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2432,1392],"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// HeyGen video status values: waiting, pending, processing, completed, failed\n// Route to appropriate output based on status\nconst status = $input.item.json.data?.status;\n\n// Preserve all data from previous nodes for downstream use\nconst prevData = $('Extract Video ID').first().json;\nconst enrichedItem = {\n  json: {\n    ...prevData,\n    heygen_status: status,\n    video_url: $input.item.json.data?.video_url || null\n  }\n};\n\n// Output 0 = completed (ready to download)\n// Output 1 = still processing (retry)\n// Output 2 = failed (error)\nif (status === 'completed') {\n  return [enrichedItem, null, null];\n} else if (status === 'waiting' || status === 'pending' || status === 'processing') {\n  return [null, enrichedItem, null];\n} else {\n  // failed or unknown\n  return [null, null, enrichedItem];\n}"},"id":"route-status-switch","name":"Route Status","type":"n8n-nodes-base.code","typeVersion":2,"position":[944,1776]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\n\nconst items = $input.all();\nconst prevData = items[0].json;\n\n// Get data from previous nodes\nlet scriptId, sourceUrl, sourcePlatform;\n\ntry {\n  scriptId = $('Save Script').first().json.id;\n} catch (e) {\n  scriptId = prevData.script_id || 22;\n}\n\ntry {\n  const normalizeData = $('Normalize Idea').first().json;\n  sourceUrl = normalizeData.source_url;\n  sourcePlatform = normalizeData.source_platform;\n} catch (e) {\n  sourceUrl = prevData.source_url || '';\n  sourcePlatform = prevData.source_platform || 'unknown';\n}\n\nconst expectedPath = `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\n\n// Check if file exists\nif (fs.existsSync(expectedPath)) {\n  const stats = fs.statSync(expectedPath);\n  return [{\n    json: {\n      saved_path: expectedPath,\n      script_id: scriptId,\n      source_platform: sourcePlatform,\n      source_url: sourceUrl,\n      file_size: stats.size,\n      verified: true\n    }\n  }];\n}\n\n// Try to find any file with this prefix\nconst dir = '/home/node/.n8n-files/assets/videos/';\ntry {\n  const files = fs.readdirSync(dir).filter(f => f.startsWith(`${scriptId}_source`));\n  if (files.length > 0) {\n    const foundPath = `${dir}${files[0]}`;\n    const stats = fs.statSync(foundPath);\n    return [{\n      json: {\n        saved_path: foundPath,\n        script_id: scriptId,\n        source_platform: sourcePlatform,\n        source_url: sourceUrl,\n        file_size: stats.size,\n        verified: true\n      }\n    }];\n  }\n} catch (e) {\n  console.log('Error checking directory:', e.message);\n}\n\n// No file found - return with verified=false but don't throw\nreturn [{\n  json: {\n    saved_path: expectedPath,\n    script_id: scriptId,\n    source_platform: sourcePlatform,\n    source_url: sourceUrl,\n    verified: false,\n    error: 'Source video file not found'\n  }\n}];"},"id":"verify-download","name":"Verify Download","type":"n8n-nodes-base.code","typeVersion":2,"position":[288,928]},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const fs = require('fs');\nconst { execSync } = require('child_process');\n\nconst items = $input.all();\nconst prevData = items[0].json;\n\n// Get script ID from previous nodes\nlet scriptId;\ntry {\n  scriptId = $('Save Script').first().json.id;\n} catch (e) {\n  scriptId = prevData.script_id || 22;\n}\n\nlet sourceUrl;\ntry {\n  sourceUrl = $('Normalize Idea').first().json.source_url;\n} catch (e) {\n  sourceUrl = prevData.source_url || '';\n}\n\nconst outputPath = `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\n\n// Check if file already exists\nif (fs.existsSync(outputPath)) {\n  const stats = fs.statSync(outputPath);\n  if (stats.size > 1000) { // File exists and is not empty\n    console.log(`Source video already exists: ${outputPath} (${stats.size} bytes)`);\n    return [{\n      json: {\n        success: true,\n        skipped: true,\n        output_path: outputPath,\n        script_id: scriptId,\n        source_url: sourceUrl,\n        file_size: stats.size\n      }\n    }];\n  }\n}\n\n// Try to download with yt-dlp if available\ntry {\n  const cmd = `yt-dlp -f 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best' -o '${outputPath}' --no-playlist --merge-output-format mp4 '${sourceUrl}'`;\n  console.log(`Running: ${cmd}`);\n  const output = execSync(cmd, { encoding: 'utf-8', timeout: 300000 });\n  console.log(output);\n  \n  return [{\n    json: {\n      success: true,\n      skipped: false,\n      output_path: outputPath,\n      script_id: scriptId,\n      source_url: sourceUrl\n    }\n  }];\n} catch (error) {\n  // If yt-dlp fails or not found, create placeholder and continue\n  console.log(`Download failed (${error.message}), using placeholder`);\n  \n  // Check if file exists anyway (maybe partial download)\n  if (fs.existsSync(outputPath)) {\n    const stats = fs.statSync(outputPath);\n    if (stats.size > 1000) {\n      return [{\n        json: {\n          success: true,\n          skipped: true,\n          output_path: outputPath,\n          script_id: scriptId,\n          source_url: sourceUrl,\n          file_size: stats.size,\n          note: 'Using existing file after download failure'\n        }\n      }];\n    }\n  }\n  \n  // Return with error flag but don't throw - let pipeline continue\n  return [{\n    json: {\n      success: false,\n      error: error.message,\n      output_path: outputPath,\n      script_id: scriptId,\n      source_url: sourceUrl,\n      note: 'Download failed, no source video available'\n    }\n  }];\n}"},"id":"download-source-video","name":"Download Source Video","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,928]},{"id":"check-avatar-exists-early","name":"Avatar Already Exists?","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,1400],"parameters":{"jsCode":"// Check if avatar video already exists BEFORE uploading to HeyGen\n// Also check if there's an existing HeyGen video ID we can resume from\nconst fs = require('fs');\nconst ttsData = $('Prepare TTS Text').first().json;\nconst scriptId = ttsData.script_id;\nconst assetId = ttsData.asset_id;\nconst filePath = `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`;\n\nlet fileExists = false;\nlet heygenVideoId = null;\n\n// Check if local file exists\ntry {\n  fileExists = fs.existsSync(filePath);\n  console.log(`Avatar file check: ${filePath} exists=${fileExists}`);\n} catch (e) {\n  console.log(`Avatar file check error: ${e.message}`);\n}\n\n// Check database for existing heygen_video_id\ntry {\n  const response = await fetch(`http://backend:8000/api/assets/${assetId}`);\n  if (response.ok) {\n    const asset = await response.json();\n    heygenVideoId = asset.heygen_video_id || null;\n    console.log(`Database check: asset ${assetId} has heygen_video_id=${heygenVideoId}`);\n  }\n} catch (e) {\n  console.log(`Database check error: ${e.message}`);\n}\n\nconst inputData = $input.first().json;\nconst binaryData = $input.first().binary;\n\nreturn [{ \n    json: { \n        ...inputData,\n        ...ttsData,\n        avatar_exists: fileExists,\n        avatar_path: filePath,\n        heygen_video_id: heygenVideoId,\n        has_heygen_id: !!heygenVideoId\n    },\n    binary: binaryData\n}];"}},{"id":"mock-heygen-data","name":"Use Existing Avatar","type":"n8n-nodes-base.code","typeVersion":2,"position":[1700,1300],"parameters":{"jsCode":"// Mock the data that would come from HeyGen for testing\n// Also pass through source_video_path and voice_path for FFmpeg\nconst items = $input.all();\nif (!items || items.length === 0) {\n  return [{ json: { error: 'No input data', success: false } }];\n}\nconst inputData = items[0].json;\nconst scriptId = inputData.script_id;\n\n// Get source video path from earlier in pipeline\nlet sourceVideoPath;\ntry {\n  sourceVideoPath = $('Verify Download').first().json.saved_path;\n} catch (e) {\n  sourceVideoPath = `/home/node/.n8n-files/assets/videos/${scriptId}_source.mp4`;\n}\n\n// Get voice path\nlet voicePath;\ntry {\n  voicePath = $('Update Asset Voice').first().json.voiceover_path;\n} catch (e) {\n  voicePath = `/home/node/.n8n-files/assets/audio/${scriptId}_voice.mp3`;\n}\n\n// Get settings from Fetch Settings node\nlet settings;\ntry {\n  settings = $('Fetch Settings').first().json.settings;\n} catch (e) {\n  settings = {\n    audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n    video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow' }\n  };\n}\n\nreturn [{\n  json: {\n    asset_id: inputData.asset_id,\n    script_id: scriptId,\n    content_idea_id: inputData.content_idea_id,\n    avatar_path: `/home/node/.n8n-files/assets/avatar/${scriptId}_avatar.mp4`,\n    source_video_path: sourceVideoPath,\n    voice_path: voicePath,\n    settings: settings,\n    heygen_video_id: 'test-mock-id',\n    retry_count: 0,\n    max_retries: 20\n  }\n}];"}},{"id":"blotato-media-upload","name":"Blotato Media Upload","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[560,2848],"parameters":{"method":"POST","url":"https://backend.blotato.com/v2/media","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ url: $json.video_url }) }}","options":{"timeout":120000}},"credentials":{"httpHeaderAuth":{"id":"blotato","name":"blotato"}}},{"id":"dropbox-upload-code","name":"Upload to Dropbox","type":"n8n-nodes-base.code","typeVersion":2,"position":[352,2848],"parameters":{"mode":"runOnceForAllItems","jsCode":"const https = require('https');\nconst fs = require('fs');\nconst path = require('path');\n\nconst DROPBOX_TOKEN = 'sl.u.AGPRUxqBQeFd_BpLa6hBZfho-ffgtPK3ffiMqjskEb05TTaW0ZyKXDXAj1_I07xP_sEjJF8dbfPVV4sTRw2ZVwdHc4HlmGsa_RWgEE-4SrqSONBIBBdLsKGGBh7qVT2ZjRSgF1X72O6bBn1veBBFG4wmq8mVgj1KuX-fTKX2xEUfZfNkA_FzYiDQYu3MbbjFcPV_KAoMWOXDhFiW3u5pVGbhVILJWduvc2n1-wvhPBdJwAJyMWhONpr3UEh07MGjMtiqxspdNVvbgXBEVMf-8SNf3yR6j-Q29UOFBS10xz7N-OxgnW0A2rYUlJ-9WiQztjs-yVNAiWCO0MEq89ogxuvqJdm5kCwx6V4AC3WNAgnXLOq3Ccv5uD_o8DZgO9CQOyuQcaCnHm4TWaJ-RbYl5W1jTwzDudKHKTGu1aAgqB6Hyo8pLSUV2Oz6g_rhdbL4p7QiPTdbiVuwr0xFOjKALbjmdjS_kvByYxljlJDC8SfEOi_w1TEsdUAFmgukizlxI8hnFCm0gyBQx1NxTKxzGF6u9Mh19vSf4lhlQke4CMeG40xAr81LoNn_EPUdDo4gGQlk3p0maFA9a12HcPPc-URtbUhQFac5HR3s5THLKhjCh9wHgLYp0P2Ps9N47_1J4IOnxB4vQNCxAZ_yYauKjJTS8_9M4ZHD7xlAwepPLPliYfF1nDllggYTN7Me0H4Ytb7gy6Px6geVRrISgKCFUkhKyNJZW3lBzRrIfaG_4c-iGHPeXEjENK8dTZfHKMs4n5f8EAKoz4Qa1FJiwxwNvuXJJv_1yctniVWePtEq_wpqeKC6vRZ_WRBGwRYnGumcc7UJ83g2VxOcBrqxmeCSoc_Y16LW6fDqbwYxu8VhEye9k_d6MaRcXNSCzZD9xLYA2e8hXrFk3dR1--By6vTIf7W7vP75hpcWs78H2_N5eYlcIUH_3DrhJ8Tpg_jSq0I60PdRILUncp4SrjvpO85ekn8hsCgS2f3ziLGPpuIrieGc4ANKXBgBxpdR4W1AKzKCh9APUPuJdQvXDS8GzN4Nzyx9Rh8wxBgnlWhT_ik8odSicEALvq2N07txxOQocHza81MKhxJzzAlBQ2yQDDysf31YKEgbJJe_45W42a6qitns-gaqvkstG4o6xHjchxdA0zJp8dI_A93BtiB9TQhXxv3yc0LDeChgcSdh6VMJrSgpY-ukNVnxQRJoCkDmiXwlyvFjHVLbyXvW31eE1j4zVUNJ9KzAP-8U9-wUwPHKO1cZN1h-tI_neYQ7Z7RkbASadsk97W9SjOwA3JShnWaNZ6yBHL1dgGqwKOESQ5RZK6HTOQ';\n\nconst publishData = $('Prepare Publish Data').first().json;\nconst videoPath = publishData.final_video_path;\nconst scriptId = publishData.script_id;\n\n// Read file\nconst fileBuffer = fs.readFileSync(videoPath);\nconst dropboxPath = `/n8n-videos/${scriptId}_final.mp4`;\n\nreturn new Promise((resolve, reject) => {\n  const options = {\n    hostname: 'content.dropboxapi.com',\n    port: 443,\n    path: '/2/files/upload',\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${DROPBOX_TOKEN}`,\n      'Content-Type': 'application/octet-stream',\n      'Dropbox-API-Arg': JSON.stringify({\n        path: dropboxPath,\n        mode: 'overwrite',\n        autorename: false,\n        mute: false\n      })\n    },\n    timeout: 300000\n  };\n\n  const req = https.request(options, (res) => {\n    let data = '';\n    res.on('data', (chunk) => data += chunk);\n    res.on('end', () => {\n      try {\n        const parsed = JSON.parse(data);\n        resolve([{ json: { ...publishData, dropbox_path: dropboxPath, upload_response: parsed } }]);\n      } catch (e) {\n        resolve([{ json: { ...publishData, dropbox_path: dropboxPath, upload_error: data } }]);\n      }\n    });\n  });\n\n  req.on('error', (e) => resolve([{ json: { ...publishData, upload_error: e.message } }]));\n  req.on('timeout', () => {\n    req.destroy();\n    resolve([{ json: { ...publishData, upload_error: 'timeout' } }]);\n  });\n\n  req.write(fileBuffer);\n  req.end();\n});"}},{"id":"dropbox-share-code","name":"Create Share Link","type":"n8n-nodes-base.code","typeVersion":2,"position":[496,2848],"parameters":{"mode":"runOnceForAllItems","jsCode":"const https = require('https');\n\nconst DROPBOX_TOKEN = 'sl.u.AGPRUxqBQeFd_BpLa6hBZfho-ffgtPK3ffiMqjskEb05TTaW0ZyKXDXAj1_I07xP_sEjJF8dbfPVV4sTRw2ZVwdHc4HlmGsa_RWgEE-4SrqSONBIBBdLsKGGBh7qVT2ZjRSgF1X72O6bBn1veBBFG4wmq8mVgj1KuX-fTKX2xEUfZfNkA_FzYiDQYu3MbbjFcPV_KAoMWOXDhFiW3u5pVGbhVILJWduvc2n1-wvhPBdJwAJyMWhONpr3UEh07MGjMtiqxspdNVvbgXBEVMf-8SNf3yR6j-Q29UOFBS10xz7N-OxgnW0A2rYUlJ-9WiQztjs-yVNAiWCO0MEq89ogxuvqJdm5kCwx6V4AC3WNAgnXLOq3Ccv5uD_o8DZgO9CQOyuQcaCnHm4TWaJ-RbYl5W1jTwzDudKHKTGu1aAgqB6Hyo8pLSUV2Oz6g_rhdbL4p7QiPTdbiVuwr0xFOjKALbjmdjS_kvByYxljlJDC8SfEOi_w1TEsdUAFmgukizlxI8hnFCm0gyBQx1NxTKxzGF6u9Mh19vSf4lhlQke4CMeG40xAr81LoNn_EPUdDo4gGQlk3p0maFA9a12HcPPc-URtbUhQFac5HR3s5THLKhjCh9wHgLYp0P2Ps9N47_1J4IOnxB4vQNCxAZ_yYauKjJTS8_9M4ZHD7xlAwepPLPliYfF1nDllggYTN7Me0H4Ytb7gy6Px6geVRrISgKCFUkhKyNJZW3lBzRrIfaG_4c-iGHPeXEjENK8dTZfHKMs4n5f8EAKoz4Qa1FJiwxwNvuXJJv_1yctniVWePtEq_wpqeKC6vRZ_WRBGwRYnGumcc7UJ83g2VxOcBrqxmeCSoc_Y16LW6fDqbwYxu8VhEye9k_d6MaRcXNSCzZD9xLYA2e8hXrFk3dR1--By6vTIf7W7vP75hpcWs78H2_N5eYlcIUH_3DrhJ8Tpg_jSq0I60PdRILUncp4SrjvpO85ekn8hsCgS2f3ziLGPpuIrieGc4ANKXBgBxpdR4W1AKzKCh9APUPuJdQvXDS8GzN4Nzyx9Rh8wxBgnlWhT_ik8odSicEALvq2N07txxOQocHza81MKhxJzzAlBQ2yQDDysf31YKEgbJJe_45W42a6qitns-gaqvkstG4o6xHjchxdA0zJp8dI_A93BtiB9TQhXxv3yc0LDeChgcSdh6VMJrSgpY-ukNVnxQRJoCkDmiXwlyvFjHVLbyXvW31eE1j4zVUNJ9KzAP-8U9-wUwPHKO1cZN1h-tI_neYQ7Z7RkbASadsk97W9SjOwA3JShnWaNZ6yBHL1dgGqwKOESQ5RZK6HTOQ';\n\nconst input = $input.first().json;\nconst dropboxPath = input.dropbox_path;\n\n// Helper function to make HTTPS requests\nfunction makeRequest(path, body) {\n  return new Promise((resolve, reject) => {\n    const bodyStr = JSON.stringify(body);\n    const options = {\n      hostname: 'api.dropboxapi.com',\n      port: 443,\n      path: path,\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${DROPBOX_TOKEN}`,\n        'Content-Type': 'application/json',\n        'Content-Length': Buffer.byteLength(bodyStr)\n      },\n      timeout: 30000\n    };\n\n    const req = https.request(options, (res) => {\n      let data = '';\n      res.on('data', (chunk) => data += chunk);\n      res.on('end', () => {\n        try {\n          resolve(JSON.parse(data));\n        } catch (e) {\n          reject(new Error(data));\n        }\n      });\n    });\n\n    req.on('error', reject);\n    req.write(bodyStr);\n    req.end();\n  });\n}\n\n// Try to create a shared link\nconst createResponse = await makeRequest('/2/sharing/create_shared_link_with_settings', {\n  path: dropboxPath,\n  settings: { requested_visibility: 'public' }\n});\n\n// If link was created successfully, return it\nif (createResponse.url) {\n  return [{ json: { ...input, share_response: createResponse } }];\n}\n\n// If link already exists, fetch existing links\nif (createResponse.error?.['.tag'] === 'shared_link_already_exists') {\n  const listResponse = await makeRequest('/2/sharing/list_shared_links', {\n    path: dropboxPath,\n    direct_only: true\n  });\n\n  if (listResponse.links && listResponse.links.length > 0) {\n    // Return the first existing link\n    return [{ json: { ...input, share_response: { url: listResponse.links[0].url } } }];\n  }\n}\n\n// Return original response if nothing worked\nreturn [{ json: { ...input, share_response: createResponse } }];"}},{"id":"fetch-settings","name":"Fetch Settings","type":"n8n-nodes-base.code","typeVersion":2,"position":[780,224],"parameters":{"mode":"runOnceForAllItems","jsCode":"// Fetch all settings from backend API\nconst http = require('http');\n\nconst items = $input.all();\nconst inputData = items[0]?.json || {};\n\nreturn new Promise((resolve, reject) => {\n  const options = {\n    hostname: 'backend',\n    port: 8000,\n    path: '/api/settings/all',\n    method: 'GET',\n    timeout: 10000\n  };\n\n  const req = http.request(options, (res) => {\n    let data = '';\n    res.on('data', (chunk) => data += chunk);\n    res.on('end', () => {\n      try {\n        const settings = JSON.parse(data);\n        resolve([{ json: { ...inputData, settings } }]);\n      } catch (e) {\n        // Use defaults if API fails\n        resolve([{ json: {\n          ...inputData,\n          settings: {\n            audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n            video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow', greenscreen_enabled: true, greenscreen_color: '#00FF00' }\n          }\n        }}]);\n      }\n    });\n  });\n\n  req.on('error', () => {\n    // Use defaults if API fails\n    resolve([{ json: {\n      ...inputData,\n      settings: {\n        audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n        video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow', greenscreen_enabled: true, greenscreen_color: '#00FF00' }\n      }\n    }}]);\n  });\n\n  req.on('timeout', () => {\n    req.destroy();\n    resolve([{ json: {\n      ...inputData,\n      settings: {\n        audio: { original_volume: 0.7, avatar_volume: 1.0, ducking_enabled: true, avatar_delay_seconds: 3, duck_to_percent: 0.5 },\n        video: { output_width: 1080, output_height: 1920, crf: 18, preset: 'slow', greenscreen_enabled: true, greenscreen_color: '#00FF00' }\n      }\n    }}]);\n  });\n\n  req.end();\n})"}},{"id":"route-heygen-logic","name":"Route HeyGen Logic","type":"n8n-nodes-base.code","typeVersion":2,"position":[1550,1400],"parameters":{"mode":"runOnceForEachItem","jsCode":"// Route based on avatar state:\n// Output 0: File exists -> Use Existing Avatar (skip HeyGen entirely)\n// Output 1: HeyGen ID exists but no file -> Resume polling (check status)\n// Output 2: No file, no ID -> Create new HeyGen video\n\nconst item = $input.item.json;\nconst fileExists = item.avatar_exists;\nconst heygenId = item.heygen_video_id;\n\nif (fileExists) {\n  // Avatar file already exists, skip HeyGen\n  console.log('Route: File exists, skipping HeyGen');\n  return [{json: item}, null, null];\n} else if (heygenId) {\n  // HeyGen ID exists but file not downloaded yet - resume polling\n  console.log(`Route: Resuming HeyGen polling for video ${heygenId}`);\n  return [null, {json: item}, null];\n} else {\n  // No file, no ID - create new HeyGen video\n  console.log('Route: Creating new HeyGen video');\n  return [null, null, {json: item}];\n}"}},{"id":"resume-heygen-check","name":"Resume HeyGen Check","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1700,1500],"parameters":{"method":"GET","url":"=https://api.heygen.com/v1/video_status.get?video_id={{ $json.heygen_video_id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"options":{}},"credentials":{"httpHeaderAuth":{"id":"heygen","name":"heygen"}}},{"id":"route-resume-status","name":"Route Resume Status","type":"n8n-nodes-base.code","typeVersion":2,"position":[1850,1500],"parameters":{"mode":"runOnceForEachItem","jsCode":"// Route resumed HeyGen check result\n// Output 0: Completed -> Download Avatar\n// Output 1: Processing -> Wait & Retry\n// Output 2: Failed -> Stop on Failure\n\nconst item = $input.item.json;\nconst prevData = $('Route HeyGen Logic').first().json;\nconst status = item.data?.status;\n\nconst enrichedItem = {\n  ...prevData,\n  heygen_status: status,\n  video_url: item.data?.video_url || null,\n  retry_count: 0,\n  max_retries: 20\n};\n\nconsole.log(`Resume status check: ${status}`);\n\nif (status === 'completed') {\n  return [{json: enrichedItem}, null, null];\n} else if (status === 'waiting' || status === 'pending' || status === 'processing') {\n  return [null, {json: enrichedItem}, null];\n} else {\n  // failed or unknown\n  return [null, null, {json: enrichedItem}];\n}"}}],"connections":{"Daily 6am Scrape":{"main":[[{"node":"Parse Scrape Params","type":"main","index":0}]]},"Scrape Webhook":{"main":[[{"node":"Parse Scrape Params","type":"main","index":0}]]},"Parse Scrape Params":{"main":[[{"node":"TikTok?","type":"main","index":0},{"node":"Instagram?","type":"main","index":0},{"node":"YouTube?","type":"main","index":0}]]},"TikTok?":{"main":[[{"node":"Apify TikTok","type":"main","index":0}],[{"node":"Skip TikTok","type":"main","index":0}]]},"Instagram?":{"main":[[{"node":"Apify Instagram Reels","type":"main","index":0}],[{"node":"Skip Instagram","type":"main","index":0}]]},"YouTube?":{"main":[[{"node":"Apify YouTube","type":"main","index":0}],[{"node":"Skip YouTube","type":"main","index":0}]]},"Apify TikTok":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Apify Instagram Reels":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Apify YouTube":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Skip TikTok":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Skip Instagram":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Skip YouTube":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Merge Results":{"main":[[{"node":"Normalize Data","type":"main","index":0}]]},"Normalize Data":{"main":[[{"node":"Analyze with Grok","type":"main","index":0}]]},"Analyze with Grok":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Process & Save Trends","type":"main","index":0}]]},"Process & Save Trends":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Get Approved Idea","type":"main","index":0}]]},"Respond Immediately":{"main":[[{"node":"Get Approved Idea","type":"main","index":0},{"node":"Specific ID?","type":"main","index":0}]]},"Get Approved Idea":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Specific ID?":{"1":[[{"node":"Respond Immediately","type":"1","index":0}]],"main":[[{"node":"Get Specific Idea","type":"main","index":0}],[{"node":"Merge","type":"main","index":1}]]},"Get Specific Idea":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Normalize Idea","type":"main","index":0}]]},"Normalize Idea":{"main":[[{"node":"Fetch Settings","type":"main","index":0}]]},"Has Content?":{"main":[[{"node":"Update Status","type":"main","index":0}],[{"node":"No Content","type":"main","index":0}]]},"Update Status":{"main":[[{"node":"Generate Script (Grok)","type":"main","index":0}]]},"Generate Script (Grok)":{"main":[[{"node":"Parse Script","type":"main","index":0}]]},"Parse Script":{"main":[[{"node":"Save Script","type":"main","index":0}]]},"Save Script":{"main":[[{"node":"Create Asset Record","type":"main","index":0}]]},"Get Character Config":{"main":[[{"node":"Prepare TTS Text","type":"main","index":0}]]},"Prepare TTS Text":{"main":[[{"node":"Check Voice Exists","type":"main","index":0}]]},"Check Voice Exists":{"main":[[{"node":"Voice Exists?","type":"main","index":0}]]},"Voice Exists?":{"main":[[{"node":"Get Duration","type":"main","index":0}],[{"node":"Generate Voice (ElevenLabs)","type":"main","index":0}]]},"Generate Voice (ElevenLabs)":{"main":[[{"node":"Save Voice","type":"main","index":0}]]},"Save Voice":{"main":[[{"node":"Get Duration","type":"main","index":0}]]},"Get Duration":{"main":[[{"node":"Update Asset Voice","type":"main","index":0}]]},"Update Asset Voice":{"main":[[{"node":"Read Audio File","type":"main","index":0}]]},"Prepare HeyGen Data":{"main":[[{"node":"Check Video Exists","type":"main","index":0}]]},"Check Video Exists":{"main":[[{"node":"Video Exists?","type":"main","index":0}]]},"Video Exists?":{"main":[[{"node":"Build FFmpeg Command","type":"main","index":0}],[{"node":"Create HeyGen Video","type":"main","index":0}]]},"Create HeyGen Video":{"main":[[{"node":"Extract Video ID","type":"main","index":0}]]},"Extract Video ID":{"main":[[{"node":"Wait 30s","type":"main","index":0}]]},"Wait 30s":{"main":[[{"node":"Check Status","type":"main","index":0}]]},"Check Status":{"main":[[{"node":"Route Status","type":"main","index":0}]]},"Increment Retry":{"main":[[{"node":"Wait & Retry","type":"main","index":0}]]},"Wait & Retry":{"main":[[{"node":"Check Status","type":"main","index":0}]]},"Download Avatar":{"main":[[{"node":"Save Avatar","type":"main","index":0}]]},"Save Avatar":{"main":[[{"node":"Build FFmpeg Command","type":"main","index":0}]]},"Build FFmpeg Command":{"main":[[{"node":"Run FFmpeg","type":"main","index":0}]]},"Run FFmpeg":{"main":[[{"node":"Success?","type":"main","index":0}]]},"Success?":{"main":[[{"node":"Prepare Whisper","type":"main","index":0}],[{"node":"Handle Error","type":"main","index":0}]]},"Prepare Whisper":{"main":[[{"node":"Read Audio for Whisper","type":"main","index":0}]]},"Read Audio for Whisper":{"main":[[{"node":"Whisper Transcribe","type":"main","index":0}]]},"Whisper Transcribe":{"main":[[{"node":"Parse Whisper Response","type":"main","index":0}]]},"Parse Whisper Response":{"main":[[{"node":"Save SRT","type":"main","index":0}]]},"Save SRT":{"main":[[{"node":"Build Caption Cmd","type":"main","index":0}]]},"Build Caption Cmd":{"main":[[{"node":"Burn Captions","type":"main","index":0}]]},"Burn Captions":{"main":[[{"node":"Caption Success?","type":"main","index":0}]]},"Caption Success?":{"main":[[{"node":"Prepare Publish Data","type":"main","index":0}],[{"node":"Handle Caption Error","type":"main","index":0}]]},"Prepare Publish Data":{"main":[[{"node":"Read Final Video","type":"main","index":0}]]},"Publish (Blotato)":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"Save Publish Record","type":"main","index":0}]]},"Save Publish Record":{"main":[[{"node":"Update Status Published","type":"main","index":0}]]},"Serve Audio":{"main":[[{"node":"Read Audio","type":"main","index":0}]]},"Read Audio":{"main":[[{"node":"Return Audio","type":"main","index":0}]]},"Serve Video":{"main":[[{"node":"Read Video","type":"main","index":0}]]},"Read Video":{"main":[[{"node":"Return Video","type":"main","index":0}]]},"Upload HeyGen Audio":{"main":[[{"node":"Is Talking Photo?","type":"main","index":0}]]},"Is Talking Photo?":{"main":[[{"node":"Download Character Image","type":"main","index":0}],[{"node":"Prepare HeyGen Data","type":"main","index":0}]]},"Download Character Image":{"main":[[{"node":"Upload Talking Photo","type":"main","index":0}]]},"Upload Talking Photo":{"main":[[{"node":"Prepare HeyGen Data","type":"main","index":0}]]},"Route Status":{"main":[[{"node":"Download Avatar","type":"main","index":0}],[{"node":"Increment Retry","type":"main","index":0}],[{"node":"Stop on Failure","type":"main","index":0}]]},"Verify Download":{"main":[[{"node":"Get Character Config","type":"main","index":0}]]},"Create Asset Record":{"main":[[{"node":"Download Source Video","type":"main","index":0}]]},"Download Source Video":{"main":[[{"node":"Verify Download","type":"main","index":0}]]},"Read Audio File":{"main":[[{"node":"Avatar Already Exists?","type":"main","index":0}]]},"Use Existing Avatar":{"main":[[{"node":"Build FFmpeg Command","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Respond Immediately","type":"main","index":0}]]},"Parse Upload Response":{"main":[[{"node":"Blotato Media Upload","type":"main","index":0}]]},"Blotato Media Upload":{"main":[[{"node":"Publish (Blotato)","type":"main","index":0}]]},"Read Final Video":{"main":[[{"node":"Upload to Dropbox","type":"main","index":0}]]},"Upload to Dropbox":{"main":[[{"node":"Create Share Link","type":"main","index":0}]]},"Create Share Link":{"main":[[{"node":"Parse Upload Response","type":"main","index":0}]]},"Fetch Settings":{"main":[[{"node":"Has Content?","type":"main","index":0}]]},"Avatar Already Exists?":{"main":[[{"node":"Route HeyGen Logic","type":"main","index":0}]]},"Route HeyGen Logic":{"main":[[{"node":"Use Existing Avatar","type":"main","index":0}],[{"node":"Resume HeyGen Check","type":"main","index":0}],[{"node":"Upload HeyGen Audio","type":"main","index":0}]]},"Resume HeyGen Check":{"main":[[{"node":"Route Resume Status","type":"main","index":0}]]},"Route Resume Status":{"main":[[{"node":"Download Avatar","type":"main","index":0}],[{"node":"Increment Retry","type":"main","index":0}],[{"node":"Stop on Failure","type":"main","index":0}]]}},"authors":"Cameron Anderson","name":null,"description":null,"autosaved":false,"workflowPublishHistory":[{"createdAt":"2026-01-09T22:59:11.390Z","id":222,"workflowId":"LNpBI12tR5p3NX3g","versionId":"fbc654f5-62ae-47d5-9b7d-24e02adc1fea","event":"activated","userId":"a0773c81-ae88-49d0-b490-6bd27e8c7405"}]}}